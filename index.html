<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png">
    <link rel="manifest" href="manifest.json">
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
    <link rel="icon" type="image/x-icon" href="icon.ico">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>最強列強革命走る</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Impact', sans-serif; 
            background: #000; 
            touch-action: none; 
        }
        
        #game-ui { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        
        /* スコア・情報表示 */
        #score-board {
            position: absolute; 
            top: calc(10px + env(safe-area-inset-top)); 
            left: calc(10px + env(safe-area-inset-left));
            color: yellow; 
            font-size: 24px; 
            text-shadow: 2px 2px 0 #f0f; 
            z-index: 10; 
        }
        #muteki-count { color: cyan; font-size: 20px; }
        
        /* オーバーレイ共通 */
        #start-screen, #game-over-screen, #gacha-screen, #save-load-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
            overflow-y: auto; /* コンテンツが多い場合にスクロール */
        }
        
        h1 { 
            color: #ff0055; 
            font-size: 40px; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            transform: rotate(-2deg); 
            text-shadow: 4px 4px 0 #fff; 
            text-align: center;
        }
        p { color: white; text-align: center; max-width: 80%; }
        
        button {
            background: linear-gradient(45deg, #ff0, #f0f); border: none; padding: 15px 40px;
            font-size: 24px; font-weight: bold; color: #000; cursor: pointer; margin-top: 20px;
            transform: skew(-10deg); box-shadow: 5px 5px 0 #fff;
        }
        button:active { transform: skew(-10deg) translate(2px, 2px); box-shadow: 3px 3px 0 #fff; }
        button:disabled {
            background: #777;
            color: #aaa;
            box-shadow: 5px 5px 0 #555;
            cursor: not-allowed;
        }

        /* ガチャ演出用 */
        #torotuki-container { position: relative; width: 200px; height: 200px; margin-bottom: 20px; }
        #torotuki-img { width: 100%; height: 100%; object-fit: contain; transition: filter 0.1s; }
        #pickaxe { 
            position: absolute; top: -50px; right: -50px; font-size: 60px; 
            transition: transform 0.3s ease-in; opacity: 0; 
        }
        #gacha-info {
            color: white; font-size: 18px; text-align: center;
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            /* (中略) */
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* データ引き継ぎ用 */
        #save-load-screen textarea {
            width: 80%;
            height: 100px;
            margin-top: 15px;
            font-size: 14px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-ui">
        <div id="score-board">
            SCORE: <span id="score-val">0</span><br>
            DISTANCE: <span id="distance-val">0</span>m<br>
            <span id="muteki-count">無敵ボール: 0個</span>
        </div>
    </div>

    <div id="start-screen">
        <h1>最強列強<br>革命走る</h1>
        <p>スワイプ: 移動・ジャンプ・しゃがみ<br>「無敵」を集めろ！（無敵ではない）</p>

        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>現在の同志 (スキン): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        <button onclick="startGame()">革命開始</button>
        <button onclick="openGacha()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">革命ガチャ（スキン）</button>
        <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">データ引き継ぎ</button>
        
        <button id="bgm-toggle-start" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 10px; font-size: 16px;">BGM: OFF</button>
        </div>

    <div id="game-over-screen" class="hidden">
        <h1 style="color: cyan;">粛清されました</h1>
        <p>スコア: <span id="final-score">0</span></p>
        <p>走行距離: <span id="final-distance">0</span>m</p>
        <button onclick="resetGame()">再革命</button>
        <button onclick="openGacha()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">革命ガチャ</button>
        
        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>現在の同志 (スキン): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">データ引き継ぎ</button>
        
        <button id="bgm-toggle-over" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 10px; font-size: 16px;">BGM: OFF</button>
        </div>

    <div id="gacha-screen" class="hidden">
        <h1 style="color: #ffaa00;">同志召喚</h1>
        <div id="torotuki-container">
            <img id="torotuki-img" src="" alt="Trotsky Target">
            <div id="pickaxe">⛏️</div>
        </div>
        <div id="gacha-info">
            <p>1回: 無敵ボール 20個</p>
            <p>所持: <span id="gacha-muteki-count">0</span>個</p>
        </div>
        <div id="gacha-result" style="font-size: 20px; color: yellow; height: 30px;"></div>
        <button id="gacha-button" onclick="runGacha()">ピッケル投擲 (20個消費)</button>
        <button onclick="closeGacha()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>

    <div id="save-load-screen" class="hidden">
        <h1 style="color: #0a0;">データ引き継ぎ</h1>
        <p>
            セーブ: 現在のデータをコードとして発行します。<br>
            ロード: コードを入力してデータを復元します。
        </p>
        
        <button onclick="generateSaveCode()" style="font-size: 18px;">セーブ (コード発行)</button>
        
        <textarea id="save-load-code" placeholder="ここに発行されたコードを貼り付け"></textarea>
        
        <button onclick="executeLoadCode()" style="background: #00f; color: white; font-size: 18px;">ロード (実行)</button>
        
        <button onclick="closeSaveLoadScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>

    <audio id="bgm-player" src="bgm.mp3" loop preload="auto"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ==========================================
        // 設定・グローバル変数
        // ==========================================
        let scene, camera, renderer;
        let player, playerTexture, textureLoader;
        let clock, delta;
        let isPlaying = false;
        let score = 0;
        let speed = 15;
        let distance = 0; // 走行距離

        // --- データ管理 ---
        let mutekiBalls = 0;
        let currentSkin = 'player.png';
        let ownedSkins = new Set(['player.png']); // デフォルトスキン
        const GACHA_COST = 20;
        const SKIN_LIST = [
            'player.png', 'player2.jpg', 'player3.jpg', 'player4.jpg',
            'player5.jpg', 'player6.jpg', 'player7.jpg', 'player8.jpg', 'player9.jpg',
            'player10.jpg', 'player11.jpg', 'player12.jpg', 'player13.jpg', 'player14.jpg', 'player15.jpg'
        ];
        const SAVE_DATA_KEY = 'revolutionRunData';

        // レーン設定
        let currentLane = 0; 
        const LANE_WIDTH = 3.0; 
        let targetX = 0;

        // アクション状態
        let isJumping = false;
        let isCrouching = false;
        let jumpVelocity = 0;
        let gravity = -35;
        let crouchTimer = 0;

        // オブジェクト管理
        let obstacles = [];
        
        // 画像パス (ガチャのターゲット画像)
        const TOROTUKI_IMG_SRC = 'torotuki.jpg';

        // ▼▼▼ BGM用 ▼▼▼
        let bgmElement;
        let isBGMEnabled = false; // ユーザーがONにしたか
        const BGM_SAVE_KEY = 'revolutionRunBGM';
        // ▲▲▲ BGM用 ▲▲▲

        // ▼▼▼ ガチャ用レアスキン ▼▼▼
        const RARE_SKINS = [
            { name: 'fuziwara.jpg', rate: 0.005, rarity: "超絶革命" }, // 0.5%
            { name: 'kora_torotuki.png', rate: 0.005, rarity: "超絶革命" }, // 0.5%
            { name: 'poru.jpg', rate: 0.01, rarity: "超革命的" }, // 1%
            { name: 'sonbun.jpg', rate: 0.01, rarity: "超革命的" }, // 1%
            { name: TOROTUKI_IMG_SRC, rate: 0.01, rarity: "革命的" } // 1% (元の1%)
        ];
        // ▲▲▲ ガチャ用レアスキン ▲▲▲

        // ==========================================
        // 初期化・セットアップ
        // ==========================================
        function init() {
            textureLoader = new THREE.TextureLoader(); // ローダーをグローバルに
            
            // シーン
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x110022); 
            scene.fog = new THREE.FogExp2(0x110022, 0.02);

            // カメラ
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 9, 12);
            camera.lookAt(0, 0, -5);

            // レンダラー
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // ライト
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 床
            const gridHelper = new THREE.GridHelper(200, 100, 0xff0055, 0x222222);
            gridHelper.position.y = 0;
            scene.add(gridHelper);

            // プレイヤー生成
            createPlayer();

            // ガチャ用画像のセットアップ
            setupGachaImages();

            // イベントリスナー
            window.addEventListener('resize', onWindowResize);
            setupInputs(); 

            // ▼▼▼ BGMセットアップ ▼▼▼
            bgmElement = document.getElementById('bgm-player');
            loadBGMSetting(); // BGM設定のロード (isBGMEnabled が決まる)
            updateBGMButtonUI();
            bgmElement.muted = true; // BGMは最初は常にミュート
            // ▲▲▲ BGMセットアップ ▲▲▲

            // ★ロード処理
            loadData(); // この中でスキンセレクターUIも更新される

            // ループ開始
            clock = new THREE.Clock();
            animate();
        }

        // プレイヤー作成
        function createPlayer() {
            const geometry = new THREE.PlaneGeometry(1.5, 1.5);
            const material = new THREE.MeshBasicMaterial({ 
                map: null, 
                transparent: true, 
                side: THREE.DoubleSide 
            });
            player = new THREE.Mesh(geometry, material);
            player.position.y = 0.75;
            scene.add(player);
            applySkin(currentSkin);
        }

        // スキンを適用する関数
        function applySkin(skinName) {
            textureLoader.load(skinName, 
                (tex) => {
                    if (player) {
                        player.material.map = tex;
                        player.material.needsUpdate = true;
                    }
                    currentSkin = skinName; 
                },
                undefined, 
                (err) => {
                    console.error('スキン画像の読み込み失敗:', skinName, err);
                    if (player) {
                        player.material.map = createPlaceholderTexture('#ffffff');
                        player.material.needsUpdate = true;
                    }
                }
            );
        }

        // 画像がない場合の代替テクスチャ生成
        function createPlaceholderTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(64, 64, 60, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black';
            ctx.fillRect(40, 45, 15, 25); ctx.fillRect(73, 45, 15, 25);
            ctx.beginPath(); ctx.arc(64, 85, 20, 0, Math.PI, false); ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        // 「無敵」ボールのテクスチャ生成
        function createMutekiTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
            ctx.beginPath(); ctx.arc(64, 64, 64, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('無敵', 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        // ==========================================
        // ゲームループ
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            delta = clock.getDelta();

            if (isPlaying) {
                updateGame(delta);
            }
            
            renderer.render(scene, camera);
        }

        function updateGame(dt) {
            speed += dt * 0.2;
            score += Math.floor(speed * dt);
            distance += speed * dt; // 走行距離を加算
            
            // UI更新
            document.getElementById('score-val').innerText = score;
            document.getElementById('distance-val').innerText = Math.floor(distance);

            player.position.x += (targetX - player.position.x) * 10 * dt;

            if (isJumping) {
                player.position.y += jumpVelocity * dt;
                jumpVelocity += gravity * dt;
                if (player.position.y <= 0.75) {
                    player.position.y = 0.75;
                    isJumping = false;
                    jumpVelocity = 0;
                }
            } else if (isCrouching) {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 0.5, 15 * dt);
                player.position.y = 0.375;
                crouchTimer -= dt;
                if (crouchTimer <= 0) {
                    isCrouching = false;
                }
            } else {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 1.0, 15 * dt);
                player.position.y = 0.75;
            }

            player.lookAt(camera.position);

            if (Math.random() < 0.05) {
                spawnObstacle();
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obj = obstacles[i];
                obj.position.z += speed * dt;

                if (obj.userData.type === 'ball') {
                    obj.rotation.y += 5 * dt;
                    obj.rotation.x += 2 * dt;
                }

                if (Math.abs(obj.position.z - player.position.z) < 0.8) {
                    if (Math.abs(obj.position.x - player.position.x) < 1.0) {
                        checkCollision(obj, i);
                    }
                }

                if (obj.position.z > 5) {
                    scene.remove(obj);
                    obstacles.splice(i, 1);
                }
            }
        }

        // ==========================================
        // 障害物・アイテム生成
        // ==========================================
        function spawnObstacle() {
            if (obstacles.length > 0) {
                const lastObj = obstacles[obstacles.length - 1];
                if (lastObj.position.z > -25) return;
            }

            const laneIndex = Math.floor(Math.random() * 3) - 1; // -1, 0, 1
            const posX = laneIndex * LANE_WIDTH;
            const typeRand = Math.random();

            let mesh;
            let type = '';

            if (typeRand < 0.2) {
                const geometry = new THREE.SphereGeometry(0.5, 16, 16);
                const material = new THREE.MeshBasicMaterial({ map: createMutekiTexture() });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.5, -50);
                type = 'ball';
            } else if (typeRand < 0.6) {
                const geometry = new THREE.BoxGeometry(2.5, 1.2, 0.5);
                const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.6, -50);
                type = 'wall';
            } else if (typeRand < 0.4) {
                const geometry = new THREE.CylinderGeometry(1.5, 1.5, 1.0, 16, 1, true, 0, Math.PI);
                const material = new THREE.MeshStandardMaterial({ color: 0x888888, side: THREE.DoubleSide });
                mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.z = Math.PI / 2; 
                mesh.rotation.y = Math.PI / 2;
                mesh.position.set(posX, 0.5, -50);
                type = 'tunnel';
            } else {
                const geometry = new THREE.BoxGeometry(1, 4, 1);
                const material = new THREE.MeshStandardMaterial({ color: 0x5500aa });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 2, -50);
                type = 'pillar';
            }

            mesh.userData = { type: type, isObstacle: true };
            scene.add(mesh);
            obstacles.push(mesh);
        }

        // ==========================================
        // 当たり判定ロジック
        // ==========================================
        function checkCollision(obj, index) {
            const type = obj.userData.type;

            if (type === 'ball') {
                mutekiBalls++;
                score += 1000;
                updateMutekiCountUI();
                saveData(); 
                scene.remove(obj);
                obstacles.splice(index, 1);
            } else if (type === 'wall') {
                if (player.position.y < 1.2) {
                    gameOver();
                }
            } else if (type === 'tunnel') {
                if (!isCrouching) {
                    gameOver();
                }
            } else if (type === 'pillar') {
                gameOver();
            }
        }

        // 無敵ボールのUIを更新する関数
        function updateMutekiCountUI() {
            document.getElementById('muteki-count').innerText = `無敵ボール: ${mutekiBalls}個`;
        }

        // ==========================================
        // 入力処理 (スマホスワイプ対応)
        // ==========================================
        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (!isPlaying) return;
                if (e.code === 'ArrowLeft') moveLane(-1);
                if (e.code === 'ArrowRight') moveLane(1);
                if (e.code === 'ArrowUp') doJump();
                if (e.code === 'ArrowDown') doCrouch();
            });

            let touchStartX = 0;
            let touchStartY = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (!isPlaying) return;
                let touchEndX = e.changedTouches[0].clientX;
                let touchEndY = e.changedTouches[0].clientY;
                let diffX = touchEndX - touchStartX;
                let diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 30) {
                        if (diffX > 0) moveLane(1);
                        else moveLane(-1);
                    }
                } 
                else {
                    if (Math.abs(diffY) > 30) {
                        if (diffY < 0) doJump();
                        else doCrouch();
                    }
                }
            }, false);
        }

        function moveLane(dir) {
            currentLane += dir;
            if (currentLane < -1) currentLane = -1;
            if (currentLane > 1) currentLane = 1;
            targetX = currentLane * LANE_WIDTH;
        }

        function doJump() {
            if (!isJumping) {
                isJumping = true;
                jumpVelocity = 12;
            }
        }

        function doCrouch() {
            if (!isJumping) {
                isCrouching = true;
                crouchTimer = 0.8; 
            }
        }

        // ==========================================
        // ゲーム進行管理
        // ==========================================
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            resetGameVals(); 
            isPlaying = true;
            playBGM(); // BGM再生開始
        }

        function gameOver() {
            isPlaying = false;
            // stopBGM(); // BGMは止めない
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-distance').innerText = Math.floor(distance);
            updateSkinSelectorUI();
        }

        function resetGame() {
            document.getElementById('game-over-screen').classList.add('hidden');
            resetGameVals();
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            isPlaying = true;
            playBGM(); // BGM再生開始
        }

        function resetGameVals() {
            score = 0;
            speed = 15;
            distance = 0; 
            currentLane = 0;
            targetX = 0;
            player.position.x = 0;
            
            document.getElementById('score-val').innerText = '0';
            document.getElementById('distance-val').innerText = '0';
            updateMutekiCountUI();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==========================================
        // ★★★ BGM管理 (追加) ★★★
        // ==========================================

        function playBGM() {
            if (isBGMEnabled && bgmElement) {
                bgmElement.muted = false; // ミュート解除
                // ブラウザの自動再生ポリシー対策
                const promise = bgmElement.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.warn("BGMの自動再生がブロックされました。", error);
                        // 失敗したら、設定をOFFに戻す
                        isBGMEnabled = false; 
                        bgmElement.muted = true;
                        saveBGMSetting();
                        updateBGMButtonUI();
                    });
                }
            }
        }

        function toggleBGM() {
            isBGMEnabled = !isBGMEnabled;
            
            if (isBGMEnabled) {
                // ユーザーがONにした瞬間に再生を試みる
                playBGM(); 
            } else {
                // OFFにした場合
                bgmElement.muted = true;
            }
            
            saveBGMSetting();
            updateBGMButtonUI();
        }

        function updateBGMButtonUI() {
            const text = isBGMEnabled ? "BGM: ON" : "BGM: OFF";
            const color = isBGMEnabled ? "linear-gradient(45deg, #0f0, #0a0)" : "#444"; // ONの時緑に
            
            const btn1 = document.getElementById('bgm-toggle-start');
            if (btn1) {
                btn1.innerText = text;
                btn1.style.background = color;
            }
            
            const btn2 = document.getElementById('bgm-toggle-over');
            if (btn2) {
                btn2.innerText = text;
                btn2.style.background = color;
            }
        }

        function saveBGMSetting() {
            try {
                localStorage.setItem(BGM_SAVE_KEY, JSON.stringify({ enabled: isBGMEnabled }));
            } catch (e) {
                console.error("BGM設定の保存に失敗", e);
            }
        }

        function loadBGMSetting() {
            try {
                const setting = localStorage.getItem(BGM_SAVE_KEY);
                if (setting) {
                    isBGMEnabled = JSON.parse(setting).enabled || false;
                }
            } catch (e) {
                console.error("BGM設定のロードに失敗", e);
                isBGMEnabled = false;
            }
        }

        // ==========================================
        // スキン選択システム
        // ==========================================

        function updateSkinSelectorUI() {
            const selectors = document.querySelectorAll('.skin-selector');
            if (selectors.length === 0) return;

            selectors.forEach(selector => {
                selector.innerHTML = ''; 
                ownedSkins.forEach(skinName => {
                    const option = document.createElement('option');
                    option.value = skinName;
                    option.innerText = skinName.replace('.png', '').replace('.jpg', ''); 
                    if (skinName === currentSkin) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            });
        }

        function changeSkin(skinName) {
            if (ownedSkins.has(skinName)) {
                applySkin(skinName);
                saveData(); 
                console.log(`スキンを ${skinName} に変更しました。`);
                updateSkinSelectorUI();
            }
        }

        // ==========================================
        // ガチャシステム
        // ==========================================
        function setupGachaImages() {
            const img = document.getElementById('torotuki-img');
            img.onerror = function() {
                const c = document.createElement('canvas');
                c.width = 200; c.height = 200;
                const x = c.getContext('2d');
                x.fillStyle = '#ccc'; x.fillRect(0,0,200,200);
                x.fillStyle = '#000'; x.font = '30px Arial'; x.textAlign = 'center';
                x.fillText('Target', 100, 100);
                img.src = c.toDataURL();
            };
            img.src = TOROTUKI_IMG_SRC;
        }

        function openGacha() {
            document.getElementById('gacha-screen').classList.remove('hidden');
            document.getElementById('gacha-result').innerText = "";
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls;
            
            const pickaxe = document.getElementById('pickaxe');
            pickaxe.style.opacity = '0';
            pickaxe.style.transform = 'translate(0, 0) rotate(0deg)';

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = (mutekiBalls < GACHA_COST);
        }

        function closeGacha() {
            document.getElementById('gacha-screen').classList.add('hidden');
        }

        function runGacha() {
            if (mutekiBalls < GACHA_COST) {
                document.getElementById('gacha-result').innerText = "無敵ボールが足りません！";
                return;
            }

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = true;

            mutekiBalls -= GACHA_COST;
            updateMutekiCountUI(); 
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls; 
            
            const pickaxe = document.getElementById('pickaxe');
            const imgContainer = document.getElementById('torotuki-container');
            
            pickaxe.style.opacity = '1';
            pickaxe.style.top = '-50px';
            pickaxe.style.right = '-50px';
            
            setTimeout(() => {
                pickaxe.style.transform = 'translate(-80px, 80px) rotate(-45deg)'; 
                
                setTimeout(() => {
                    imgContainer.classList.add('shake');
                    
                    setTimeout(() => {
                        imgContainer.classList.remove('shake');
                        
                        // ▼▼▼ 変更 (ガチャ抽選ロジック) ▼▼▼
                        
                        let newSkin = "";
                        let resultText = "";
                        let hit = false;
                        const rand = Math.random();
                        let cumulativeRate = 0.0;

                        // レアスキン抽選 (RARE_SKINS配列順)
                        for (const rare of RARE_SKINS) {
                            cumulativeRate += rare.rate;
                            if (rand < cumulativeRate) {
                                newSkin = rare.name;
                                if (ownedSkins.has(newSkin)) {
                                    resultText = `★${rare.rarity}!!★ [${newSkin}] は既に所持しています`;
                                } else {
                                    ownedSkins.add(newSkin);
                                    updateSkinSelectorUI(); // スキン選択UIを更新
                                    resultText = `★★★${rare.rarity}同志 [${newSkin}] を召喚!!!★★★`;
                                }
                                hit = true;
                                break; // ヒットしたらループ終了
                            }
                        }

                        // 通常抽選 (レアにヒットしなかった場合)
                        if (!hit) {
                            newSkin = SKIN_LIST[Math.floor(Math.random() * SKIN_LIST.length)];
                            if (ownedSkins.has(newSkin)) {
                                resultText = `同志 [${newSkin}] は既に所持しています`;
                            } else {
                                ownedSkins.add(newSkin);
                                updateSkinSelectorUI(); // スキン選択UIを更新
                                resultText = `新規同志 [${newSkin}] を召喚！`;
                            }
                        }
                        
                        document.getElementById('gacha-result').innerText = resultText;

                        // ▲▲▲ 変更 ▲▲▲

                        saveData();

                        if (mutekiBalls >= GACHA_COST) {
                            gachaButton.disabled = false;
                        }

                    }, 500);
                }, 300);
            }, 100);
        }

        // ==========================================
        // データ引き継ぎ (セーブ/ロード)
        // ==========================================

        function saveData() {
            try {
                const data = {
                    skins: Array.from(ownedSkins),
                    balls: mutekiBalls,
                    skin: currentSkin 
                };
                localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(data));
                console.log("データを保存しました。", data);
            } catch (e) {
                console.error("セーブに失敗しました。", e);
            }
        }

        function loadData() {
            try {
                const jsonData = localStorage.getItem(SAVE_DATA_KEY);
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    
                    ownedSkins = new Set(data.skins || ['player.png']); 
                    mutekiBalls = data.balls || 0;
                    currentSkin = data.skin || 'player.png';
                    
                    console.log("データをロードしました。", data);
                    
                    updateMutekiCountUI();
                    if (player) { 
                        applySkin(currentSkin);
                    }
                }
            } catch (e) {
                console.error("ロードに失敗しました。", e);
            }
            updateSkinSelectorUI();
        }

        // --- 引き継ぎ画面UI ---
        function openSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.remove('hidden');
            document.getElementById('save-load-code').value = ''; 
        }
        
        function closeSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.add('hidden');
        }

        function generateSaveCode() {
            saveData(); 
            const jsonData = localStorage.getItem(SAVE_DATA_KEY);
            if (jsonData) {
                try {
                    const base64Code = btoa(jsonData);
                    document.getElementById('save-load-code').value = base64Code;
                    alert("引き継ぎコードを発行しました。テキストエリアのコードをコピーしてください。");
                } catch (e) {
                    alert("コードの発行に失敗しました。");
                }
            }
        }

        function executeLoadCode() {
            const base64Code = document.getElementById('save-load-code').value;
            if (!base64Code) {
                alert("コードを入力してください。");
                return;
            }
            
            try {
                const jsonData = atob(base64Code);
                const data = JSON.parse(jsonData); 
                localStorage.setItem(SAVE_DATA_KEY, jsonData);
                alert("データのロードに成功しました。ゲームを再読み込みします。");
                location.reload(); 
            } catch (e) {
                console.error("ロード失敗:", e);
                alert("無効なコードです。データ復元に失敗しました。");
            }
        }

        // スタート
        init();

    </script>
</body>
</html>
