<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png">
    <link rel="manifest" href="manifest.json">
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
    <link rel="icon" type="image/x-icon" href="icon.ico">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>最強列強革命走る</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Impact', sans-serif; 
            background: #000; 
            touch-action: none; 
        }
        
        #game-ui { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        
        /* スコア・情報表示 */
        #score-board {
            position: absolute; 
            top: calc(10px + env(safe-area-inset-top)); 
            left: calc(10px + env(safe-area-inset-left));
            color: yellow; 
            font-size: 24px; 
            text-shadow: 2px 2px 0 #f0f; 
            z-index: 10; 
        }
        #muteki-count { color: cyan; font-size: 20px; }

        /* 一時停止ボタン */
        #pause-button {
            position: absolute;
            top: calc(10px + env(safe-area-inset-top));
            right: calc(10px + env(safe-area-inset-right));
            font-size: 24px;
            font-weight: bold;
            background: #ff0;
            color: #000;
            border: 2px solid #fff;
            width: 40px;
            height: 40px;
            cursor: pointer;
            pointer-events: auto; /* ★重要 */
            z-index: 15;
            padding: 0;
            line-height: 36px;
        }
        
        /* オーバーレイ共通 */
        #start-screen, #game-over-screen, #gacha-screen, #save-load-screen, #pause-screen, #skin-list-screen, #custom-skin-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
            overflow-y: auto; /* コンテンツが多い場合にスクロール */
        }
        
        h1 { 
            color: #ff0055; 
            font-size: 40px; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            transform: rotate(-2deg); 
            text-shadow: 4px 4px 0 #fff; 
            text-align: center;
        }

        /* ▼▼▼ 追加: タイトルロゴ画像用スタイル ▼▼▼ */
        #title-logo {
            max-width: 90%;      /* 画面からはみ出さないように */
            height: auto;        /* 比率を維持 */
            margin-bottom: 20px;
            filter: drop-shadow(4px 4px 0 #fff); /* 元のテキストのような影をつける */
            transform: rotate(-2deg); /* 元のテキストのような傾きをつける */
        }
        /* ▲▲▲ 追加 ▲▲▲ */

        p { color: white; text-align: center; max-width: 80%; }
        
        button {
            background: linear-gradient(45deg, #ff0, #f0f); border: none; padding: 15px 40px;
            font-size: 24px; font-weight: bold; color: #000; cursor: pointer; margin-top: 20px;
            transform: skew(-10deg); box-shadow: 5px 5px 0 #fff;
        }
        button:active { transform: skew(-10deg) translate(2px, 2px); box-shadow: 3px 3px 0 #fff; }
        button:disabled {
            background: #777;
            color: #aaa;
            box-shadow: 5px 5px 0 #555;
            cursor: not-allowed;
        }

        /* ガチャ演出用 */
        #torotuki-container { position: relative; width: 200px; height: 200px; margin-bottom: 20px; }
        #torotuki-img { width: 100%; height: 100%; object-fit: contain; transition: filter 0.1s; }
        #pickaxe { 
            position: absolute; top: -50px; right: -50px; font-size: 60px; 
            transition: transform 0.3s ease-in; opacity: 0; 
        }
        #gacha-info {
            color: white; font-size: 18px; text-align: center;
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            /* (中略) */
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* データ引き継ぎ用 */
        #save-load-screen textarea {
            width: 80%;
            height: 100px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        #skin-list-container {
            width: 80%; max-width: 500px; height: 60vh; 
            background: #222; border: 2px solid #0ff; 
            overflow-y: auto; padding: 10px; 
            box-sizing: border-box; text-align: left;
        }
        #skin-list-container h3 {
            color: white; margin: 15px 0 5px 0;
            border-bottom: 1px solid #555;
        }
        #skin-list-container div {
            padding: 8px; border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between; 
            align-items: center; flex-wrap: wrap;
        }
        #skin-list-container .owned {
            color: #0f0; font-weight: bold; white-space: nowrap; padding-right: 10px;
        }
        #skin-list-container .not-owned {
            color: #888; white-space: nowrap; padding-right: 10px;
        }
        #skin-list-container .skin-prob {
            color: #ff0; font-size: 14px; white-space: nowrap;
        }


        .hidden { display: none !important; }
    </style>
</head>
<body>

    <img id="custom-skin-gif-source" style="display: none;" crossOrigin="anonymous">
    <div id="game-ui">
        <div id="score-board">
            SCORE: <span id="score-val">0</span><br>
            DISTANCE: <span id="distance-val">0</span>m<br>
            <span id="muteki-count">無敵ボール: 0個</span>
        </div>
        <button id="pause-button" class="hidden" onclick="togglePause()">II</button>
    </div>

    <div id="start-screen">
        <img src="title.png" id="title-logo" alt="最強列強革命走る" width="250px">
        
        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>現在の同志 (スキン): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        
        <p style="color: yellow; font-size: 16px; margin-top: 15px; margin-bottom: 0;">
            <span>
            最高スコア: <span id="high-score-start">0</span>
            最長距離: <span id="high-distance-start">0</span>m
            </span>
        </p>
        
        <button onclick="startGame(false)">革命開始</button>

        <button id="awakening-start-btn" onclick="startAwakeningGame()" class="hidden" style="background: linear-gradient(45deg, #ff0, #f80); color: #000; margin-top: 10px; font-size: 18px;">
            覚醒スタート (5000mから)
        </button>
        <button id="awakening-unlock-btn" onclick="unlockAwakening()" class="hidden" style="background: linear-gradient(45deg, #f00, #a00); color: white; margin-top: 10px; font-size: 18px;">
            覚醒スタート解放 (無敵 200個消費)
        </button>
        <button onclick="openGacha()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">革命ガチャ（スキン）</button>
        <button onclick="openSkinListScreen()" style="background: #0ff; color: #000; margin-top: 10px; font-size: 16px;">同志一覧</button> <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">データ引き継ぎ</button>
        <button onclick="openCustomSkinScreen()" style="background: #0f0; color: #000; margin-top: 10px; font-size: 16px;">オリジナル同志作成</button>
        <button id="bgm-toggle-start" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 10px; font-size: 16px;">BGM: OFF</button>
        <button onclick="location.href='https://github.com/iamthe000/SaikyoRekkyoKakumeiHashiru/blob/main/index.html'" style="background: #444; color: white;padding: 5px; margin-top: 30px; font-size: 8px;">このゲームのソースコードはGitHubで公開されています</button>

        </div>

    <div id="game-over-screen" class="hidden">
        <h1 style="color: cyan;">粛清されました</h1>
        <p>スコア: <span id="final-score">0</span></p>
        <p>走行距離: <span id="final-distance">0</span>m</p>
        
        <p style="color: yellow; font-size: 16px;">
            <span>(最高スコア: <span id="high-score-over">0</span> | 最長距離: <span id="high-distance-over">0</span>m)</span>
        </p>

        <button onclick="resetGame(false)">再革命</button>

        <button id="awakening-start-btn-over" onclick="startAwakeningGame()" class="hidden" style="background: linear-gradient(45deg, #ff0, #f80); color: #000; margin-top: 10px; font-size: 18px;">
            覚醒スタート (5000mから)
        </button>
        <button id="awakening-unlock-btn-over" onclick="unlockAwakening()" class="hidden" style="background: linear-gradient(45deg, #f00, #a00); color: white; margin-top: 10px; font-size: 18px;">
            覚醒スタート解放 (無敵 200個消費)
        </button>
        <button onclick="openGacha()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">革命ガチャ</button>
        
        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>現在の同志 (スキン): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        <button onclick="openSkinListScreen()" style="background: #0ff; color: #000; margin-top: 10px; font-size: 16px;">同志一覧</button> <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">データ引き継ぎ</button>
        <button onclick="openCustomSkinScreen()" style="background: #0f0; color: #000; margin-top: 10px; font-size: 16px;">オリジナル同志作成</button>
        
        <button id="bgm-toggle-over" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 10px; font-size: 16px;">BGM: OFF</button>
        </div>

    <div id="gacha-screen" class="hidden">
        <h1 style="color: #ffaa00;">同志召喚</h1>
        <div id="torotuki-container">
            <img id="torotuki-img" src="" alt="Trotsky Target">
            <div id="pickaxe">⛏️</div>
        </div>
        <div id="gacha-info">
            <p>1回: 無敵ボール 20個</p>
            <p>所持: <span id="gacha-muteki-count">0</span>個</p>
        </div>
        <div id="gacha-result" style="font-size: 20px; color: yellow; height: 30px;"></div>
        <button id="gacha-button" onclick="runGacha()">ピッケル投擲 (20個消費)</button>
        <button onclick="closeGacha()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>

    <div id="save-load-screen" class="hidden">
        <h1 style="color: #0a0;">データ引き継ぎ</h1>
        <p>
            セーブ: 現在のデータをコードとして発行します。<br>
            ロード: コードを入力してデータを復元します。
        </p>
        
        <button onclick="generateSaveCode()" style="font-size: 18px;">セーブ (コード発行)</button>
        
        <textarea id="save-load-code" placeholder="ここに発行されたコードを貼り付け"></textarea>
        
        <button onclick="executeLoadCode()" style="background: #00f; color: white; font-size: 18px;">ロード (実行)</button>
        
        <button onclick="closeSaveLoadScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>

    <div id="pause-screen" class="hidden">
        <h1 style="color: #ff0;">一時停止</h1>
        <button onclick="togglePause()">革命続行</button>
        <button onclick="returnToStart()" style="background: #888; color: white; margin-top: 10px; font-size: 18px;">革命を中断 (タイトルへ)</button>
    </div>

    <div id="skin-list-screen" class="hidden">
        <h1 style="color: #0ff;">同志一覧</h1>
        <p>所持している同志 (スキン) と、召喚可能な同志の一覧です。</p>
        <div id="skin-list-container">
            </div>
        <button onclick="closeSkinListScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>

    <div id="custom-skin-screen" class="hidden">
        <h1 style="color: #0f0;">オリジナル同志作成</h1>
        <p>
            ここに画像をアップロードして、<br>
            あなただけのオリジナル同志（スキン）を作成できます。
        </p>
        <p style="font-size: 16px; color: #ff0; border: 1px solid #ff0; padding: 10px; max-width: 80%;">
            <strong>注意:</strong><br>
            ・アップロードした同志は、このブラウザ（キャッシュ）がクリアされると消えてしまいます。<br>
            ・「データ引き継ぎ」機能では保存されません。<br>
            ・引き継ぎやキャッシュクリア後は、再度アップロードが必要です。
        </p>
        
        <input type="file" id="custom-skin-upload" accept="image/png, image/jpeg, image/gif" style="margin-top: 20px; color: white; font-size: 16px;">
        <div style="margin-top: 15px;">
            <img id="custom-skin-preview" src="" alt="Preview" style="max-width: 150px; max-height: 150px; border: 2px solid #555; background: #333; display: none;">
        </div>
        
        <button id="custom-skin-save" onclick="saveCustomSkin()" style="font-size: 18px;" disabled>この同志で決定</button>
        <button onclick="closeCustomSkinScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">戻る</button>
    </div>


    <audio id="bgm-player" src="bgm.mp3" loop preload="auto"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ==========================================
        // 設定・グローバル変数
        // ==========================================
        let scene, camera, renderer;
        let player, playerTexture, textureLoader;
        let clock, delta;
        let isPlaying = false;
        let isPaused = false; 
        // ▼▼▼ 追加 (自動一時停止の状態を保持するフラグ) ▼▼▼
        let isAutoPaused = false;
        // ▲▲▲ 追加 ▼▼▼
        let score = 0;
        let speed = 15;
        let distance = 0; // 走行距離
        let highScore = 0; 
        let highDistance = 0; 

        // ▼▼▼ 追加 (覚醒スタート用) ▼▼▼
        let isAwakeningUnlocked = false; 
        const AWAKENING_UNLOCK_COST = 200;
        const AWAKENING_START_DISTANCE = 5000;
        const AWAKENING_START_SPEED = 47; // 5000m到達時の想定スピード (計算値)
        const AWAKENING_START_SCORE = 5000; // 距離と合わせる
        // ▲▲▲ 追加 ▲▲▲

        // --- データ管理 ---
        let mutekiBalls = 0;
        let currentSkin = 'player.png';
        let ownedSkins = new Set(['player.png']); // デフォルトスキン
        const GACHA_COST = 20;
        const SKIN_LIST = [
            'player.png', 'player2.jpg', 'player3.jpg', 'player4.jpg', 'player5.jpg', 'player6.jpg', 'player7.jpg', 'player8.jpg', 'player9.jpg', 'player10.jpg', 'player11.jpg', 'player12.jpg', 'player13.jpg', 'player14.jpg', 'player15.jpg', 'player16.jpg', 'player17.jpg'
        ];
        const SAVE_DATA_KEY = 'revolutionRunData';

        // ▼▼▼ 追加/変更 (カスタムスキン用) ▼▼▼
        const CUSTOM_SKIN_ID = 'custom_skin.png'; // カスタムスキンの内部ID
        const CUSTOM_SKIN_KEY = 'revolutionRunCustomSkin'; // localStorageキー (DataURL)
        const CUSTOM_SKIN_TYPE_KEY = 'revolutionRunCustomSkinType'; // ( 'static' or 'gif' )
        let customSkinDataURL = null; // カスタムスキンのData URLを保持
        let isCustomSkinAnimated = false; // カスタムスキンがGIFかどうか
        let customSkinGifElement; // GIFアニメーション用の <img> 要素
        // ▲▲▲ 追加/変更 ▲▲▲

        // レーン設定
        let currentLane = 0; 
        const LANE_WIDTH = 3.0; 
        let targetX = 0;

        // アクション状態
        let isJumping = false;
        let isCrouching = false;
        let jumpVelocity = 0;
        let gravity = -35;
        let crouchTimer = 0;

        // オブジェクト管理
        let obstacles = [];
        let lastObstacleTypes = []; // 障害物生成の履歴
        
        // 画像パス (ガチャのターゲット画像)
        const TOROTUKI_IMG_SRC = 'torotuki.jpg';

        // BGM用
        let bgmElement;
        let isBGMEnabled = false; 
        const BGM_SAVE_KEY = 'revolutionRunBGM';

        // ガチャ用レアスキン
        const RARE_SKINS = [
            { name: 'fuziwara.jpg', rate: 0.005, rarity: "超絶革命" }, // 0.5%
            { name: 'kora_torotuki.png', rate: 0.005, rarity: "超絶革命" }, // 0.5%
            { name: 'sonbun.jpg', rate: 0.01, rarity: "超革命的" }, // 1%
            { name: 'poru.jpg', rate: 0.01, rarity: "超革命的" }, // 1%
            { name: 'ejof.png', rate: 0.01, rarity: "超革命的" }, 
            { name: 'matoryo.png', rate: 0.1, rarity: "超革命的" }, // 10%
            { name: TOROTUKI_IMG_SRC, rate: 0.01, rarity: "革命的" } // 1% (元の1%)
        ];

        // ==========================================
        // 初期化・セットアップ
        // ==========================================
        function init() {
            textureLoader = new THREE.TextureLoader(); 
            
            // シーン
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x110022); 
            scene.fog = new THREE.FogExp2(0x110022, 0.02);

            // カメラ
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 9, 12);
            camera.lookAt(0, 0, -5);

            // レンダラー
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // ライト
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 床
            const gridHelper = new THREE.GridHelper(200, 100, 0xff0055, 0x222222);
            gridHelper.position.y = 0;
            scene.add(gridHelper);

            // プレイヤー生成
            createPlayer();

            // ガチャ用画像のセットアップ
            setupGachaImages();

            // ▼▼▼ 追加/変更 ▼▼▼
            setupCustomSkinUploader();
            customSkinGifElement = document.getElementById('custom-skin-gif-source');
            // ▲▲▲ 追加/変更 ▼▼▼

            // イベントリスナー
            window.addEventListener('resize', onWindowResize);
            setupInputs(); 
            // ▼▼▼ 追加: visibilitychangeリスナー ▼▼▼
            setupVisibilityListeners();
            // ▲▲▲ 追加: visibilitychangeリスナー ▼▼▼

            // BGMセットアップ
            bgmElement = document.getElementById('bgm-player');
            loadBGMSetting(); 
            updateBGMButtonUI();
            bgmElement.muted = true; 

            // ★ロード処理
            loadData(); // この中でスキンセレクターUIとハイスコアUIと覚醒UIが更新される

            // ループ開始
            clock = new THREE.Clock();
            animate();
        }

        // プレイヤー作成
        function createPlayer() {
            const geometry = new THREE.PlaneGeometry(1.5, 1.5);
            const material = new THREE.MeshBasicMaterial({ 
                map: null, 
                transparent: true, 
                side: THREE.DoubleSide 
            });
            player = new THREE.Mesh(geometry, material);
            player.position.y = 0.75;
            scene.add(player);
            applySkin(currentSkin);
        }

        // ▼▼▼ 変更 (GIF対応のため applySkin を大幅に変更) ▼▼▼
        // スキンを適用する関数
        function applySkin(skinName) {
            
            const onTextureError = (err) => {
                console.error('スキン画像の読み込み失敗:', skinName, err);
                if (player) {
                    player.material.map = createPlaceholderTexture('#ffffff');
                    player.material.needsUpdate = true;
                }
            };

            if (skinName === CUSTOM_SKIN_ID) {
                // --- カスタムスキンの場合 ---
                if (isCustomSkinAnimated && customSkinDataURL) {
                    // 1. アニメーションGIF の場合
                    try {
                        // <img> 要素のsrcをセット
                        if (customSkinGifElement.src !== customSkinDataURL) {
                            customSkinGifElement.src = customSkinDataURL;
                        }
                        
                        // <img> 要素から新しいTextureを作成
                        const gifTexture = new THREE.Texture(customSkinGifElement);
                        gifTexture.needsUpdate = true; // 最初のフレームをアップロード
                        
                        if (player) {
                            player.material.map = gifTexture;
                            player.material.needsUpdate = true;
                        }
                        currentSkin = skinName;

                    } catch (e) {
                        onTextureError(e);
                    }
                } else if (customSkinDataURL) {
                    // 2. 静止画 (PNG/JPG) の場合
                    textureLoader.load(customSkinDataURL, 
                        (tex) => {
                            if (player) {
                                player.material.map = tex;
                                player.material.needsUpdate = true;
                            }
                            currentSkin = skinName; 
                        },
                        undefined, 
                        onTextureError
                    );
                } else {
                    // 3. データが失われている場合
                    console.warn("カスタムスキンが選択されていますが、データが見つかりません。デフォルトに戻します。");
                    applySkin('player.png'); // デフォルトスキンを適用
                    currentSkin = 'player.png'; // currentSkinもリセット
                    return;
                }
            } else {
                // --- 通常のスキンの場合 ---
                textureLoader.load(skinName, 
                    (tex) => {
                        if (player) {
                            player.material.map = tex;
                            player.material.needsUpdate = true;
                        }
                        currentSkin = skinName; 
                    },
                    undefined, 
                    onTextureError
                );
            }
        }
        // ▲▲▲ 変更 ▲▲▲

        // 画像がない場合の代替テクスチャ生成
        function createPlaceholderTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(64, 64, 60, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black';
            ctx.fillRect(40, 45, 15, 25); ctx.fillRect(73, 45, 15, 25);
            ctx.beginPath(); ctx.arc(64, 85, 20, 0, Math.PI, false); ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        // 「無敵」ボールのテクスチャ生成
        function createMutekiTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
            ctx.beginPath(); ctx.arc(64, 64, 64, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('無敵', 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        // ==========================================
        // ゲームループ
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            delta = clock.getDelta();

            if (isPlaying && !isPaused) {
                updateGame(delta);
            }
            
            // ▼▼▼ 追加 (GIFアニメーションの更新) ▼▼▼
            if (currentSkin === CUSTOM_SKIN_ID && isCustomSkinAnimated && player.material.map) {
                // GIFが設定されている場合、毎フレームテクスチャを更新
                player.material.map.needsUpdate = true;
            }
            // ▲▲▲ 追加 ▼▼▼

            renderer.render(scene, camera);
        }

        function updateGame(dt) {
            speed += dt * 0.2;
            score += Math.floor(speed * dt);
            distance += speed * dt; // 走行距離を加算
            
            // UI更新
            document.getElementById('score-val').innerText = score;
            document.getElementById('distance-val').innerText = Math.floor(distance);

            player.position.x += (targetX - player.position.x) * 10 * dt;

            if (isJumping) {
                player.position.y += jumpVelocity * dt;
                jumpVelocity += gravity * dt;

                if (isCrouching) {
                    player.scale.y = THREE.MathUtils.lerp(player.scale.y, 0.5, 15 * dt);
                    if (player.position.y <= 0.375) { 
                        player.position.y = 0.375;
                        isJumping = false;
                        jumpVelocity = 0;
                    }
                } else {
                    player.scale.y = THREE.MathUtils.lerp(player.scale.y, 1.0, 15 * dt);
                    if (player.position.y <= 0.75) {
                        player.position.y = 0.75;
                        isJumping = false;
                        jumpVelocity = 0;
                    }
                }
            
            } else if (isCrouching) {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 0.5, 15 * dt);
                player.position.y = 0.375;
                crouchTimer -= dt; 
                if (crouchTimer <= 0) { 
                    isCrouching = false;
                }

            } else {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 1.0, 15 * dt);
                player.position.y = 0.75;
            }

            player.lookAt(camera.position);

            if (Math.random() < 0.05) {
                spawnObstacle();
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obj = obstacles[i];
                obj.position.z += speed * dt;

                if (obj.userData.type === 'ball') {
                    obj.rotation.y += 5 * dt;
                    obj.rotation.x += 2 * dt;
                }

                if (Math.abs(obj.position.z - player.position.z) < 0.8) {
                    if (Math.abs(obj.position.x - player.position.x) < 1.0) {
                        checkCollision(obj, i);
                    }
                }

                if (obj.position.z > 5) {
                    scene.remove(obj);
                    obstacles.splice(i, 1);
                }
            }
        }

        // ==========================================
        // 障害物・アイテム生成
        // ==========================================
        function spawnObstacle() {
            if (obstacles.length > 0) {
                const lastObj = obstacles[obstacles.length - 1];
                if (lastObj.position.z > -25) return;
            }

            const laneIndex = Math.floor(Math.random() * 3) - 1; // -1, 0, 1
            const posX = laneIndex * LANE_WIDTH;
            let typeRand = Math.random();

            // 3連続で紫の壁(pillar)が出現するのを防ぐ
            if (lastObstacleTypes.length === 2 && lastObstacleTypes.every(t => t === 'pillar')) {
                typeRand = Math.random() * 0.7; // pillarでない障害物を強制的に生成
            }

            let mesh;
            let type = '';

            if (typeRand < 0.2) {
                const geometry = new THREE.SphereGeometry(0.5, 16, 16);
                const material = new THREE.MeshBasicMaterial({ map: createMutekiTexture() });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.5, -50);
                type = 'ball';
            } else if (typeRand < 0.5) {
                const geometry = new THREE.BoxGeometry(2.5, 1.2, 0.5);
                const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.6, -50);
                type = 'wall';
            } else if (typeRand < 0.7) {
                const geometry = new THREE.CylinderGeometry(1.5, 1.5, 1.0, 16, 1, true, 0, Math.PI);
                const material = new THREE.MeshStandardMaterial({ color: 0x888888, side: THREE.DoubleSide });
                mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.z = Math.PI / 2; 
                mesh.rotation.y = Math.PI / 2;
                mesh.position.set(posX, 0.5, -50);
                type = 'tunnel';
            } else {
                const geometry = new THREE.BoxGeometry(1, 4, 1);
                const material = new THREE.MeshStandardMaterial({ color: 0x5500aa });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 2, -50);
                type = 'pillar';
            }

            // 履歴を更新
            lastObstacleTypes.push(type);
            if (lastObstacleTypes.length > 2) {
                lastObstacleTypes.shift();
            }

            mesh.userData = { type: type, isObstacle: true };
            mesh.castShadow = true;
            scene.add(mesh);
            obstacles.push(mesh);
        }

        // ==========================================
        // 当たり判定ロジック
        // ==========================================
        function checkCollision(obj, index) {
            const type = obj.userData.type;

            if (type === 'ball') {
                mutekiBalls++;
                score += 1000;
                updateMutekiCountUI();
                updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
                saveData(); 
                scene.remove(obj);
                obstacles.splice(index, 1);
            } else if (type === 'wall') {
                if (player.position.y < 1.2) {
                    gameOver();
                }
            } else if (type === 'tunnel') {
                if (!isCrouching) {
                    gameOver();
                }
            } else if (type === 'pillar') {
                gameOver();
            }
        }

        // 無敵ボールのUIを更新する関数
        function updateMutekiCountUI() {
            document.getElementById('muteki-count').innerText = `無敵ボール: ${mutekiBalls}個`;
        }

        // ==========================================
        // 入力処理 (スマホスワイプ対応)
        // ==========================================
        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (!isPlaying) return;

                if (e.code === 'KeyP' || e.code === 'Escape') {
                    togglePause();
                    return; 
                }
                if (isPaused) return; 

                if (e.code === 'ArrowLeft') moveLane(-1);
                if (e.code === 'ArrowRight') moveLane(1);
                if (e.code === 'ArrowUp') doJump();
                if (e.code === 'ArrowDown') doCrouch();
            });

            let touchStartX = 0;
            let touchStartY = 0;

            document.addEventListener('touchstart', (e) => {
                if (!isPlaying || isPaused) return; 
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (!isPlaying || isPaused) return;
                let touchEndX = e.changedTouches[0].clientX;
                let touchEndY = e.changedTouches[0].clientY;
                let diffX = touchEndX - touchStartX;
                let diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 30) {
                        if (diffX > 0) moveLane(1);
                        else moveLane(-1);
                    }
                } 
                else {
                    if (Math.abs(diffY) > 30) {
                        if (diffY < 0) doJump();
                        else doCrouch();
                    }
                }
            }, false);
        }

        function moveLane(dir) {
            currentLane += dir;
            if (currentLane < -1) currentLane = -1;
            if (currentLane > 1) currentLane = 1;
            targetX = currentLane * LANE_WIDTH;
        }

        function doJump() {
            if (!isJumping) {
                isJumping = true;
                jumpVelocity = 12;
            }
        }

        function doCrouch() {
            if (isJumping) {
                if (jumpVelocity > -15) { 
                    jumpVelocity = -25;
                }
            } else { 
                isCrouching = true;
                crouchTimer = 0.8; 
            }
        }

        // ==========================================
        // ゲーム進行管理
        // ==========================================

        function togglePause() {
            if (!isPlaying) return; 
            
            // ▼▼▼ 変更: 自動一時停止中は手動再開を許可しない ▼▼▼
            if (isAutoPaused) return;
            // ▲▲▲ 変更 ▼▼▼

            isPaused = !isPaused;
            const pauseScreen = document.getElementById('pause-screen');

            if (isPaused) {
                pauseScreen.classList.remove('hidden');
                if (bgmElement) {
                    bgmElement.pause(); 
                }
            } else {
                pauseScreen.classList.add('hidden');
                playBGM(); 
            }
        }
        
        // ▼▼▼ 追加: 自動一時停止/再開機能 ▼▼▼
        function setupVisibilityListeners() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('pagehide', autoPause);
            window.addEventListener('pageshow', autoResume);
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                // ページが非表示になった
                autoPause();
            } else {
                // ページが再び表示された
                autoResume();
            }
        }

        function autoPause() {
            if (isPlaying && !isPaused) {
                isPaused = true;
                isAutoPaused = true; // 自動一時停止フラグをセット
                document.getElementById('pause-screen').classList.remove('hidden');
                document.getElementById('pause-screen').querySelector('h1').innerText = "自動一時停止"; // ユーザーに通知
                document.getElementById('pause-button').classList.add('hidden'); // 手動ボタンを隠す
                if (bgmElement) {
                    bgmElement.pause(); 
                }
            }
        }

        function autoResume(event) {
            // pageshowイベント経由、かつBFキャッシュからの復元でない場合(つまり通常の初回読み込み)は何もしない
            if (event && event.persisted === false) {
                return;
            }

            if (isPlaying && isAutoPaused) {
                isPaused = false;
                isAutoPaused = false; // フラグをリセット
                document.getElementById('pause-screen').classList.add('hidden');
                document.getElementById('pause-screen').querySelector('h1').innerText = "一時停止"; // 元に戻す
                document.getElementById('pause-button').classList.remove('hidden'); // 手動ボタンを再表示
                playBGM(); 
            }
        }
        // ▲▲▲ 追加 ▼▼▼

        function returnToStart() {
            document.getElementById('pause-screen').classList.add('hidden');
            document.getElementById('pause-button').classList.add('hidden');
            
            isPlaying = false;
            isPaused = false;
            isAutoPaused = false; // ▼▼▼ 追加 ▼▼▼
            
            if (bgmElement) {
                bgmElement.pause();
                bgmElement.currentTime = 0; 
            }

            document.getElementById('start-screen').classList.remove('hidden');
            
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            
            resetGameVals();
            updateSkinSelectorUI();
            updateHighScoreUI(); 
            updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
        }


        function startGame(isAwakening = false) { // ▼▼▼ 変更 ▼▼▼
            document.getElementById('start-screen').classList.add('hidden');
            resetGameVals(isAwakening); // ▼▼▼ 変更 ▼▼▼
            isPlaying = true;
            playBGM(); 
            document.getElementById('pause-button').classList.remove('hidden'); 
            isAutoPaused = false; // 念のためリセット
        }

        function gameOver() {
            isPlaying = false;
            document.getElementById('pause-button').classList.add('hidden'); 
            
            if (score > highScore) {
                highScore = score;
            }
            const finalDist = Math.floor(distance);
            if (finalDist > highDistance) {
                highDistance = finalDist;
            }
            saveData(); 
            updateHighScoreUI();
            updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
            
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-distance').innerText = finalDist;
            updateSkinSelectorUI();
            isAutoPaused = false; // 念のためリセット
        }

        function resetGame(isAwakening = false) { // ▼▼▼ 変更 ▼▼▼
            document.getElementById('game-over-screen').classList.add('hidden');
            resetGameVals(isAwakening); // ▼▼▼ 変更 ▼▼▼
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            isPlaying = true;
            playBGM(); 
            document.getElementById('pause-button').classList.remove('hidden'); 
            isAutoPaused = false; // 念のためリセット
        }

        function resetGameVals(isAwakening = false) { // ▼▼▼ 変更 ▼▼▼
            if (isAwakening) {
                score = AWAKENING_START_SCORE;
                speed = AWAKENING_START_SPEED;
                distance = AWAKENING_START_DISTANCE;
            } else {
                score = 0;
                speed = 15;
                distance = 0; 
            }
            
            currentLane = 0;
            targetX = 0;
            player.position.x = 0;
            
            isJumping = false;
            isCrouching = false;
            isPaused = false; 
            jumpVelocity = 0;
            crouchTimer = 0;
            
            document.getElementById('score-val').innerText = score;
            document.getElementById('distance-val').innerText = Math.floor(distance);
            updateMutekiCountUI();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==========================================
        // BGM管理
        // ==========================================

        function playBGM() {
            // ▼▼▼ 変更: isAutoPaused のチェックも追加 ▼▼▼
            if (isBGMEnabled && bgmElement && !isPaused && !isAutoPaused) {
            // ▲▲▲ 変更 ▼▼▼
                bgmElement.muted = false; 
                const promise = bgmElement.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.warn("BGMの自動再生がブロックされました。", error);
                        isBGMEnabled = false; 
                        bgmElement.muted = true;
                        saveBGMSetting();
                        updateBGMButtonUI();
                    });
                }
            }
        }

        function toggleBGM() {
            isBGMEnabled = !isBGMEnabled;
            
            if (isBGMEnabled) {
                playBGM(); 
            } else {
                bgmElement.pause(); 
                bgmElement.muted = true;
            }
            
            saveBGMSetting();
            updateBGMButtonUI();
        }

        function updateBGMButtonUI() {
            const text = isBGMEnabled ? "BGM: ON" : "BGM: OFF";
            const color = isBGMEnabled ? "linear-gradient(45deg, #0f0, #0a0)" : "#444"; 
            
            const btn1 = document.getElementById('bgm-toggle-start');
            if (btn1) {
                btn1.innerText = text;
                btn1.style.background = color;
            }
            
            const btn2 = document.getElementById('bgm-toggle-over');
            if (btn2) {
                btn2.innerText = text;
                btn2.style.background = color;
            }
        }

        function saveBGMSetting() {
            try {
                localStorage.setItem(BGM_SAVE_KEY, JSON.stringify({ enabled: isBGMEnabled }));
            } catch (e) {
                console.error("BGM設定の保存に失敗", e);
            }
        }

        function loadBGMSetting() {
            try {
                const setting = localStorage.getItem(BGM_SAVE_KEY);
                if (setting) {
                    isBGMEnabled = JSON.parse(setting).enabled || false;
                }
            } catch (e) {
                console.error("BGM設定のロードに失敗", e);
                isBGMEnabled = false;
            }
        }

        // ==========================================
        // スキン選択システム
        // ==========================================

        function updateSkinSelectorUI() {
            const selectors = document.querySelectorAll('.skin-selector');
            if (selectors.length === 0) return;

            selectors.forEach(selector => {
                selector.innerHTML = ''; 
                ownedSkins.forEach(skinName => {
                    const option = document.createElement('option');
                    option.value = skinName;
                    
                    if (skinName === CUSTOM_SKIN_ID) {
                        option.innerText = 'オリジナル同志';
                    } else {
                        option.innerText = skinName.replace('.png', '').replace('.jpg', ''); 
                    }

                    if (skinName === currentSkin) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            });
        }

        function changeSkin(skinName) {
            if (ownedSkins.has(skinName)) {
                applySkin(skinName);
                saveData(); 
                console.log(`スキンを ${skinName} に変更しました。`);
                updateSkinSelectorUI();
            }
        }

        // ==========================================
        // ガチャシステム
        // ==========================================
        function setupGachaImages() {
            const img = document.getElementById('torotuki-img');
            img.onerror = function() {
                const c = document.createElement('canvas');
                c.width = 200; c.height = 200;
                const x = c.getContext('2d');
                x.fillStyle = '#ccc'; x.fillRect(0,0,200,200);
                x.fillStyle = '#000'; x.font = '30px Arial'; x.textAlign = 'center';
                x.fillText('Target', 100, 100);
                img.src = c.toDataURL();
            };
            img.src = TOROTUKI_IMG_SRC;
        }

        function openGacha() {
            document.getElementById('gacha-screen').classList.remove('hidden');
            document.getElementById('gacha-result').innerText = "";
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls;
            
            const pickaxe = document.getElementById('pickaxe');
            pickaxe.style.opacity = '0';
            pickaxe.style.transform = 'translate(0, 0) rotate(0deg)';

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = (mutekiBalls < GACHA_COST);
            
            updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
        }

        function closeGacha() {
            document.getElementById('gacha-screen').classList.add('hidden');
        }

        function runGacha() {
            if (mutekiBalls < GACHA_COST) {
                document.getElementById('gacha-result').innerText = "無敵ボールが足りません！";
                return;
            }

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = true;

            mutekiBalls -= GACHA_COST;
            updateMutekiCountUI(); 
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls; 
            updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
            
            const pickaxe = document.getElementById('pickaxe');
            const imgContainer = document.getElementById('torotuki-container');
            
            pickaxe.style.opacity = '1';
            pickaxe.style.top = '-50px';
            pickaxe.style.right = '-50px';
            
            setTimeout(() => {
                pickaxe.style.transform = 'translate(-80px, 80px) rotate(-45deg)'; 
                
                setTimeout(() => {
                    imgContainer.classList.add('shake');
                    
                    setTimeout(() => {
                        imgContainer.classList.remove('shake');
                        
                        let newSkin = "";
                        let resultText = "";
                        let hit = false;
                        const rand = Math.random();
                        let cumulativeRate = 0.0;

                        for (const rare of RARE_SKINS) {
                            cumulativeRate += rare.rate;
                            if (rand < cumulativeRate) {
                                newSkin = rare.name;
                                if (ownedSkins.has(newSkin)) {
                                    resultText = `★${rare.rarity}!!★ [${newSkin}] は既に所持しています`;
                                } else {
                                    ownedSkins.add(newSkin);
                                    updateSkinSelectorUI(); 
                                    resultText = `★★★${rare.rarity}同志 [${newSkin}] を召喚!!!★★★`;
                                }
                                hit = true;
                                break; 
                            }
                        }

                        if (!hit) {
                            newSkin = SKIN_LIST[Math.floor(Math.random() * SKIN_LIST.length)];
                            if (ownedSkins.has(newSkin)) {
                                resultText = `同志 [${newSkin}] は既に所持しています`;
                            } else {
                                ownedSkins.add(newSkin);
                                updateSkinSelectorUI(); 
                                resultText = `新規同志 [${newSkin}] を召喚！`;
                            }
                        }
                        
                        document.getElementById('gacha-result').innerText = resultText;
                        saveData();

                        if (mutekiBalls >= GACHA_COST) {
                            gachaButton.disabled = false;
                        }

                    }, 500);
                }, 300);
            }, 100);
        }

        // ==========================================
        // ★★★ スキン一覧 & ハイスコアUI ★★★
        // ==========================================

        function updateHighScoreUI() {
            const hsStart = document.getElementById('high-score-start');
            const hdStart = document.getElementById('high-distance-start');
            const hsOver = document.getElementById('high-score-over');
            const hdOver = document.getElementById('high-distance-over');
            
            if (hsStart) hsStart.innerText = highScore;
            if (hdStart) hdStart.innerText = highDistance;
            if (hsOver) hsOver.innerText = highScore;
            if (hdOver) hdOver.innerText = highDistance;
        }

        function openSkinListScreen() {
            document.getElementById('skin-list-screen').classList.remove('hidden');
            populateSkinList();
        }

        function closeSkinListScreen() {
            document.getElementById('skin-list-screen').classList.add('hidden');
        }

        function populateSkinList() {
            const container = document.getElementById('skin-list-container');
            container.innerHTML = ''; 
            
            const defaultSkin = 'player.png';
            const rareSkinNames = RARE_SKINS.map(s => s.name);
            const normalSkinNames = SKIN_LIST.filter(s => s !== defaultSkin && !rareSkinNames.includes(s) && s !== CUSTOM_SKIN_ID);

            let html = '';
            
            if (ownedSkins.has(CUSTOM_SKIN_ID)) {
                html += `<h3 style="color: #0f0;">オリジナル同志</h3>`;
                html += createSkinListEntry(CUSTOM_SKIN_ID, null);
            }

            // Default Skin
            html += `<h3>デフォルト</h3>`;
            html += createSkinListEntry(defaultSkin, null);
            
            // Rare Skins
            html += `<h3 style="color: #ffaa00;">革命的同志 (レア)</h3>`;
            RARE_SKINS.forEach(rareInfo => {
                html += createSkinListEntry(rareInfo.name, rareInfo);
            });

            // Normal Skins
            html += `<h3 style="color: #ccc;">一般同志</h3>`;
            normalSkinNames.forEach(skinName => {
                html += createSkinListEntry(skinName, null);
            });

            container.innerHTML = html;
        }

        function createSkinListEntry(skinName, rareInfo) {
            const isOwned = ownedSkins.has(skinName);

            let nameDisplay = skinName.replace('.png', '').replace('.jpg', '');
            if (skinName === CUSTOM_SKIN_ID) {
                nameDisplay = 'オリジナル同志';
            }

            let probabilityText = "";

            if (rareInfo) {
                let percent = rareInfo.rate * 100; // 0.005 -> 0.5, 0.01 -> 1
                probabilityText = ` (${rareInfo.rarity}, ${percent}%)`;
            
            } else if (skinName === CUSTOM_SKIN_ID) {
                // ▼▼▼ 変更 (GIF対応) ▼▼▼
                probabilityText = isCustomSkinAnimated ? " (カスタム, GIF)" : " (カスタム)";
                // ▲▲▲ 変更 ▲▲▲
            } else if (skinName !== 'player.png') {
                probabilityText = " (通常)";
            } else {
                probabilityText = " (初期)";
            }
            
            const ownedClass = isOwned ? 'owned' : 'not-owned';
            const ownedText = isOwned ? '[所持]' : '[未所持]';
            
            let entry = `<div>
                            <span class="${ownedClass}">${ownedText} ${nameDisplay}</span>
                            <span class="skin-prob">${probabilityText}</span>
                         </div>`;
            return entry;
        }

        // ==========================================
        // ★★★ カスタムスキン機能 ★★★ (GIF対応)
        // ==========================================

        function setupCustomSkinUploader() {
            const uploader = document.getElementById('custom-skin-upload');
            const preview = document.getElementById('custom-skin-preview');
            const saveButton = document.getElementById('custom-skin-save');

            uploader.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    // ▼▼▼ 追加 (ファイルタイプをボタンに保存) ▼▼▼
                    saveButton.dataset.fileType = file.type; // e.g., 'image/gif'
                    // ▲▲▲ 追加 ▲▲▲

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        saveButton.disabled = false;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                    saveButton.disabled = true;
                    saveButton.dataset.fileType = ''; // ▼ 追加
                }
            });
        }

        function openCustomSkinScreen() {
            document.getElementById('custom-skin-screen').classList.remove('hidden');
            // UIをリセット
            document.getElementById('custom-skin-upload').value = null;
            document.getElementById('custom-skin-preview').style.display = 'none';
            document.getElementById('custom-skin-save').disabled = true;
            document.getElementById('custom-skin-save').dataset.fileType = '';
        }

        function closeCustomSkinScreen() {
            document.getElementById('custom-skin-screen').classList.add('hidden');
        }

        function saveCustomSkin() {
            const preview = document.getElementById('custom-skin-preview');
            const saveButton = document.getElementById('custom-skin-save');
            const dataURL = preview.src;
            // ▼▼▼ 変更 (ファイルタイプを取得) ▼▼▼
            const fileType = saveButton.dataset.fileType; 
            // ▲▲▲ 変更 ▲▲▲

            if (dataURL) {
                try {
                    // カスタムスキンを専用キーでlocalStorageに保存
                    localStorage.setItem(CUSTOM_SKIN_KEY, dataURL);
                    customSkinDataURL = dataURL; 
                    
                    // ▼▼▼ 追加 (ファイルタイプも保存) ▼▼▼
                    if (fileType === 'image/gif') {
                        localStorage.setItem(CUSTOM_SKIN_TYPE_KEY, 'gif');
                        isCustomSkinAnimated = true;
                        customSkinGifElement.src = dataURL; // <img>要素にすぐ反映
                    } else {
                        localStorage.setItem(CUSTOM_SKIN_TYPE_KEY, 'static');
                        isCustomSkinAnimated = false;
                    }
                    // ▲▲▲ 追加 ▲▲▲
                    
                    if (!ownedSkins.has(CUSTOM_SKIN_ID)) {
                        ownedSkins.add(CUSTOM_SKIN_ID);
                    }
                    
                    // 新しいスキンを即座に適用し、(currentSkinとして)保存する
                    changeSkin(CUSTOM_SKIN_ID); // これが applySkin と saveData を呼ぶ
                    updateSkinSelectorUI(); // ドロップダウンを更新

                    alert("オリジナル同志を作成しました！");
                    closeCustomSkinScreen();

                } catch (e) {
                    console.error("カスタムスキンの保存に失敗", e);
                    alert("スキンの保存に失敗しました。画像が大きすぎる可能性があります。");
                }
            }
        }

        // ==========================================
        // データ引き継ぎ (セーブ/ロード)
        // ==========================================

        function saveData() {
            try {
                const data = {
                    skins: Array.from(ownedSkins),
                    balls: mutekiBalls,
                    skin: currentSkin,
                    highScore: highScore, 
                    highDistance: highDistance,
                    isAwakeningUnlocked: isAwakeningUnlocked // ▼▼▼ 追加 ▼▼▼
                };
                // ★注意: ここにはカスタムスキンの画像データ(dataURL)は含まれない
                localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(data));
                console.log("データを保存しました。", data);
            } catch (e) {
                console.error("セーブに失敗しました。", e);
            }
        }

        function loadData() {
            // 1. メインのセーブデータをロード
            try {
                const jsonData = localStorage.getItem(SAVE_DATA_KEY);
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    
                    ownedSkins = new Set(data.skins || ['player.png']); 
                    mutekiBalls = data.balls || 0;
                    currentSkin = data.skin || 'player.png';
                    highScore = data.highScore || 0; 
                    highDistance = data.highDistance || 0; 
                    isAwakeningUnlocked = data.isAwakeningUnlocked || false; // ▼▼▼ 追加 ▼▼▼
                    
                    console.log("メインデータをロードしました。", data);
                    
                    updateMutekiCountUI();
                }
            } catch (e) {
                console.error("ロードに失敗しました。", e);
            }

            // ▼▼▼ 変更 (カスタムスキンタイプ(GIF)のロード処理) ▼▼▼
            // 2. カスタムスキンデータをロード
            try {
                const customData = localStorage.getItem(CUSTOM_SKIN_KEY);
                const customType = localStorage.getItem(CUSTOM_SKIN_TYPE_KEY); // タイプを取得

                if (customData) {
                    // カスタムスキンデータ(DataURL)が存在する場合
                    customSkinDataURL = customData;
                    ownedSkins.add(CUSTOM_SKIN_ID); // 所有リストに強制追加
                    
                    if (customType === 'gif') {
                        isCustomSkinAnimated = true;
                        customSkinGifElement.src = customSkinDataURL; // <img>にセット
                    } else {
                        isCustomSkinAnimated = false;
                    }

                } else {
                    // カスタムスキンデータが存在しない場合 (キャッシュクリアなど)
                    customSkinDataURL = null;
                    isCustomSkinAnimated = false; // リセット
                    ownedSkins.delete(CUSTOM_SKIN_ID); // 所有リストから削除
                    if (currentSkin === CUSTOM_SKIN_ID) {
                        currentSkin = 'player.png'; // デフォルトに戻す
                    }
                }
            } catch (e) {
                console.error("カスタムスキンのロードに失敗", e);
                isCustomSkinAnimated = false;
            }
            // ▲▲▲ 変更 ▲▲▲

            // 3. 最終的なスキンを適用
            if (player) { 
                applySkin(currentSkin);
            }
            
            // 4. UIを更新
            updateSkinSelectorUI();
            updateHighScoreUI(); 
            updateAwakeningUI(); // ▼▼▼ 追加 ▼▼▼
        }

        // --- 引き継ぎ画面UI ---
        function openSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.remove('hidden');
            document.getElementById('save-load-code').value = ''; 
        }
        
        function closeSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.add('hidden');
        }

        function generateSaveCode() {
            saveData(); // ★最新のデータを保存 (カスタムスキンのDataURLは含まない)
            const jsonData = localStorage.getItem(SAVE_DATA_KEY);
            if (jsonData) {
                try {
                    const base64Code = btoa(jsonData);
                    document.getElementById('save-load-code').value = base64Code;
                    alert("引き継ぎコードを発行しました。テキストエリアのコードをコピーしてください。");
                } catch (e) {
                    alert("コードの発行に失敗しました。");
                }
            }
        }

        function executeLoadCode() {
            const base64Code = document.getElementById('save-load-code').value;
            if (!base64Code) {
                alert("コードを入力してください。");
                return;
            }
            
            try {
                const jsonData = atob(base64Code);
                const data = JSON.parse(jsonData); 
                
                // ▼▼▼ 変更 (isAwakeningUnlockedのチェックは任意項目として扱う) ▼▼▼
                if (data && typeof data.skins !== 'undefined' && typeof data.balls !== 'undefined') {
                    // メインデータのみを保存
                    localStorage.setItem(SAVE_DATA_KEY, jsonData);
                    
                    // ★重要: カスタムスキンデータ(KEY/TYPE_KEY)は上書きしない
                    
                    alert("データのロードに成功しました。ゲームを再読み込みします。");
                    location.reload(); 
                } else {
                    throw new Error("無効なデータ形式です。");
                }
            } catch (e) {
                console.error("ロード失敗:", e);
                alert("無効なコードです。データ復元に失敗しました。");
            }
        }

        // ==========================================
        // ▼▼▼ 追加 (覚醒スタート用) ▼▼▼
        // ==========================================

        function updateAwakeningUI() {
            const unlockBtn = document.getElementById('awakening-unlock-btn');
            const startBtn = document.getElementById('awakening-start-btn');
            const unlockBtnOver = document.getElementById('awakening-unlock-btn-over');
            const startBtnOver = document.getElementById('awakening-start-btn-over');

            if (isAwakeningUnlocked) {
                // 解放済み
                unlockBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                unlockBtnOver.classList.add('hidden');
                startBtnOver.classList.remove('hidden');
            } else {
                // 未解放
                unlockBtn.classList.remove('hidden');
                startBtn.classList.add('hidden');
                unlockBtnOver.classList.remove('hidden');
                startBtnOver.classList.add('hidden');

                // コストが足りているか
                if (mutekiBalls >= AWAKENING_UNLOCK_COST) {
                    unlockBtn.disabled = false;
                    unlockBtnOver.disabled = false;
                    unlockBtn.innerText = `覚醒スタート解放 (無敵 ${AWAKENING_UNLOCK_COST}個消費)`;
                    unlockBtnOver.innerText = `覚醒スタート解放 (無敵 ${AWAKENING_UNLOCK_COST}個消費)`;
                } else {
                    unlockBtn.disabled = true;
                    unlockBtnOver.disabled = true;
                    unlockBtn.innerText = `解放 (無敵 ${AWAKENING_UNLOCK_COST}個必要)`;
                    unlockBtnOver.innerText = `解放 (無敵 ${AWAKENING_UNLOCK_COST}個必要)`;
                }
            }
        }

        function unlockAwakening() {
            if (isAwakeningUnlocked) return; 
            
            if (mutekiBalls >= AWAKENING_UNLOCK_COST) {
                mutekiBalls -= AWAKENING_UNLOCK_COST;
                isAwakeningUnlocked = true;
                
                updateMutekiCountUI();
                updateAwakeningUI();
                saveData(); // 保存
                
                alert(`覚醒スタートを解放しました！\n(無敵ボール ${AWAKENING_UNLOCK_COST}個消費)`);
            } else {
                alert(`無敵ボールが ${AWAKENING_UNLOCK_COST}個 必要です。`);
            }
        }

        function startAwakeningGame() {
            if (!isAwakeningUnlocked) {
                alert("覚醒スタートは解放されていません。");
                return;
            }

            // スタート画面かゲームオーバー画面かを判定して閉じる
            if (!document.getElementById('start-screen').classList.contains('hidden')) {
                startGame(true); // スタート画面から覚醒スタート
            } else if (!document.getElementById('game-over-screen').classList.contains('hidden')) {
                resetGame(true); // ゲームオーバー画面から覚醒スタート
            }
        }
        // ▲▲▲ 追加 ▼▼▼

        // スタート
        init();

    </script>
</body>
</html>
