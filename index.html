<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="apple-touch-icon" sizes="192x192" href="icon192x192.png">
    <link rel="manifest" href="manifest.json">
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
    <link rel="icon" type="image/x-icon" href="icon.ico">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æœ€å¼·åˆ—å¼·é©å‘½èµ°ã‚‹</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Impact', sans-serif; 
            background: #000; 
            touch-action: none; 
        }
        
        #game-ui { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
        }
        
        /* ã‚¹ã‚³ã‚¢ãƒ»æƒ…å ±è¡¨ç¤º */
        #score-board {
            position: absolute; 
            top: calc(10px + env(safe-area-inset-top)); 
            left: calc(10px + env(safe-area-inset-left));
            color: yellow; 
            font-size: 24px; 
            text-shadow: 2px 2px 0 #f0f; 
            z-index: 10; 
        }
        #muteki-count { color: cyan; font-size: 20px; }

        /* ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ */
        #pause-button {
            position: absolute;
            top: calc(10px + env(safe-area-inset-top));
            right: calc(10px + env(safe-area-inset-right));
            font-size: 24px;
            font-weight: bold;
            background: #ff0;
            color: #000;
            border: 2px solid #fff;
            width: 40px;
            height: 40px;
            cursor: pointer;
            pointer-events: auto; /* â˜…é‡è¦ */
            z-index: 15;
            padding: 0;
            line-height: 36px;
        }
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š */
        #start-screen, #game-over-screen, #gacha-selection-screen, #gacha-screen, #save-load-screen, #pause-screen, #skin-list-screen, #custom-skin-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box;
            overflow-y: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¤šã„å ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        
        h1 { 
            color: #ff0055; 
            font-size: 40px; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            transform: rotate(-2deg); 
            text-shadow: 4px 4px 0 #fff; 
            text-align: center;
        }

        /* â–¼â–¼â–¼ è¿½åŠ : ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ç”»åƒç”¨ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        #title-logo {
            max-width: 90%;      /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
            height: auto;        /* æ¯”ç‡ã‚’ç¶­æŒ */
            margin-bottom: 20px;
            filter: drop-shadow(4px 4px 0 #fff); /* å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã®ã‚ˆã†ãªå½±ã‚’ã¤ã‘ã‚‹ */
            transform: rotate(-2deg); /* å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã®ã‚ˆã†ãªå‚¾ãã‚’ã¤ã‘ã‚‹ */
        }
        /* â–²â–²â–² è¿½åŠ  â–²â–²â–² */

        p { color: white; text-align: center; max-width: 80%; }
        
        button {
            background: linear-gradient(45deg, #ff0, #f0f); border: none; padding: 15px 40px;
            font-size: 24px; font-weight: bold; color: #000; cursor: pointer; margin-top: 20px;
            transform: skew(-10deg); box-shadow: 5px 5px 0 #fff;
        }
        button:active { transform: skew(-10deg) translate(2px, 2px); box-shadow: 3px 3px 0 #fff; }
        button:disabled {
            background: #777;
            color: #aaa;
            box-shadow: 5px 5px 0 #555;
            cursor: not-allowed;
        }

        /* ã‚¬ãƒãƒ£æ¼”å‡ºç”¨ */
        #torotuki-container { position: relative; width: 200px; height: 200px; margin-bottom: 20px; }
        #torotuki-img { width: 100%; height: 100%; object-fit: contain; transition: filter 0.1s; }
        #pickaxe { 
            position: absolute; top: -50px; right: -50px; font-size: 60px; 
            transition: transform 0.3s ease-in; opacity: 0; 
        }
        #gacha-info {
            color: white; font-size: 18px; text-align: center;
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            /* (ä¸­ç•¥) */
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ãç”¨ */
        #save-load-screen textarea {
            width: 80%;
            height: 100px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        #skin-list-container {
            width: 80%; max-width: 500px; height: 60vh; 
            background: #222; border: 2px solid #0ff; 
            overflow-y: auto; padding: 10px; 
            box-sizing: border-box; text-align: left;
        }
        #skin-list-container h3 {
            color: white; margin: 15px 0 5px 0;
            border-bottom: 1px solid #555;
        }
        #skin-list-container div {
            padding: 8px; border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between; 
            align-items: center; flex-wrap: wrap;
        }
        #skin-list-container .owned {
            color: #0f0; font-weight: bold; white-space: nowrap; padding-right: 10px;
        }
        #skin-list-container .not-owned {
            color: #888; white-space: nowrap; padding-right: 10px;
        }
        #skin-list-container .skin-prob {
            color: #ff0; font-size: 14px; white-space: nowrap;
        }
        
        /* BGMç®¡ç†ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .bgm-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
            border: 1px solid #555;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 400px;
        }
        .bgm-controls button {
            margin-top: 5px;
            font-size: 14px;
            padding: 8px 15px;
            width: 100%;
        }


        .hidden { display: none !important; }
    </style>
</head>
<body>

    <img id="custom-skin-gif-source" style="display: none;" crossOrigin="anonymous">
    <input type="file" id="bgm-upload-input" accept="audio/*" style="display: none;">

    <div id="game-ui">
        <div id="score-board">
            SCORE: <span id="score-val">0</span><br>
            DISTANCE: <span id="distance-val">0</span>m<br>
            <span id="muteki-count">ç„¡æ•µãƒœãƒ¼ãƒ«: 0å€‹</span>
        </div>
        <button id="pause-button" class="hidden" onclick="togglePause()">II</button>
    </div>

    <div id="start-screen">
        <img src="title.png" id="title-logo" alt="æœ€å¼·åˆ—å¼·é©å‘½èµ°ã‚‹" width="250px">
        
        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>ç¾åœ¨ã®åŒå¿— (ã‚¹ã‚­ãƒ³): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        
        <p style="color: yellow; font-size: 16px; margin-top: 15px; margin-bottom: 0;">
            <span>
            æœ€é«˜ã‚¹ã‚³ã‚¢: <span id="high-score-start">0</span>
            æœ€é•·è·é›¢: <span id="high-distance-start">0</span>m
            </span>
        </p>
        
        <button onclick="startGame(false)">é©å‘½é–‹å§‹</button>

        <button id="awakening-start-btn" onclick="startAwakeningGame()" class="hidden" style="background: linear-gradient(45deg, #ff0, #f80); color: #000; margin-top: 10px; font-size: 18px;">
            è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆ (5000mã‹ã‚‰)
        </button>
        <button id="awakening-unlock-btn" onclick="unlockAwakening()" class="hidden" style="background: linear-gradient(45deg, #f00, #a00); color: white; margin-top: 10px; font-size: 18px;">
            è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆè§£æ”¾ (ç„¡æ•µ 200å€‹æ¶ˆè²»)
        </button>
        <button onclick="openGachaSelection()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">é©å‘½ã‚¬ãƒãƒ£ï¼ˆã‚¹ã‚­ãƒ³ï¼‰</button>
        <button onclick="openSkinListScreen()" style="background: #0ff; color: #000; margin-top: 10px; font-size: 16px;">åŒå¿—ä¸€è¦§</button> <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã</button>
        <button onclick="openCustomSkinScreen()" style="background: #0f0; color: #000; margin-top: 10px; font-size: 16px;">ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—ä½œæˆ</button>
        
        <div class="bgm-controls">
            <button id="bgm-toggle-start" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 0; font-size: 16px;">BGM: OFF</button>
            <div style="display: flex; gap: 5px; width: 100%;">
                <button onclick="triggerBGMUpload()" style="background: #666; color: white; font-size: 12px; padding: 5px;">ğŸµ BGMå¤‰æ›´ (UP)</button>
                <button onclick="resetDefaultBGM()" style="background: #666; color: white; font-size: 12px; padding: 5px;">â†© ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>
            </div>
        </div>

        <button onclick="location.href='https://github.com/iamthe000/SaikyoRekkyoKakumeiHashiru/blob/main/index.html'" style="background: #444; color: white;padding: 5px; margin-top: 30px; font-size: 8px;">ã“ã®ã‚²ãƒ¼ãƒ ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯GitHubã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™</button>

        </div>

    <div id="game-over-screen" class="hidden">
        <h1 style="color: cyan;">ç²›æ¸…ã•ã‚Œã¾ã—ãŸ</h1>
        <p>ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>
        <p>èµ°è¡Œè·é›¢: <span id="final-distance">0</span>m</p>
        
        <p style="color: yellow; font-size: 16px;">
            <span>(æœ€é«˜ã‚¹ã‚³ã‚¢: <span id="high-score-over">0</span> | æœ€é•·è·é›¢: <span id="high-distance-over">0</span>m)</span>
        </p>

        <button onclick="resetGame(false)">å†é©å‘½</button>

        <button id="awakening-start-btn-over" onclick="startAwakeningGame()" class="hidden" style="background: linear-gradient(45deg, #ff0, #f80); color: #000; margin-top: 10px; font-size: 18px;">
            è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆ (5000mã‹ã‚‰)
        </button>
        <button id="awakening-unlock-btn-over" onclick="unlockAwakening()" class="hidden" style="background: linear-gradient(45deg, #f00, #a00); color: white; margin-top: 10px; font-size: 18px;">
            è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆè§£æ”¾ (ç„¡æ•µ 200å€‹æ¶ˆè²»)
        </button>
        <button onclick="openGachaSelection()" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 18px;">é©å‘½ã‚¬ãƒãƒ£</button>
        <div style="color: white; margin-top: 15px; font-size: 18px;">
            <label>ç¾åœ¨ã®åŒå¿— (ã‚¹ã‚­ãƒ³): </label>
            <select class="skin-selector" onchange="changeSkin(this.value)" style="font-size: 16px; padding: 5px; background: #333; color: white; border: 2px solid #f0f;">
                </select>
        </div>
        <button onclick="openSkinListScreen()" style="background: #0ff; color: #000; margin-top: 10px; font-size: 16px;">åŒå¿—ä¸€è¦§</button> <button onclick="openSaveLoadScreen()" style="background: #0a0; color: white; margin-top: 10px; font-size: 16px;">ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã</button>
        <button onclick="openCustomSkinScreen()" style="background: #0f0; color: #000; margin-top: 10px; font-size: 16px;">ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—ä½œæˆ</button>
        
        <div class="bgm-controls">
            <button id="bgm-toggle-over" onclick="toggleBGM()" style="background: #444; color: white; margin-top: 0; font-size: 16px;">BGM: OFF</button>
            <div style="display: flex; gap: 5px; width: 100%;">
                <button onclick="triggerBGMUpload()" style="background: #666; color: white; font-size: 12px; padding: 5px;">ğŸµ BGMå¤‰æ›´ (UP)</button>
                <button onclick="resetDefaultBGM()" style="background: #666; color: white; font-size: 12px; padding: 5px;">â†© ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>
            </div>
        </div>

        </div>

    <div id="gacha-selection-screen" class="hidden">
        <h1 style="color: #ffaa00;">åŒå¿—å¬å–š</h1>
        <p>ã©ã®ã‚¬ãƒãƒ£ã‚’å¼•ãã¾ã™ã‹ï¼Ÿ</p>

        <button onclick="openGacha('rare')" style="background: linear-gradient(45deg, #f0f, #a0f); color: white; margin-top: 20px; font-size: 20px;">
            è³‡æœ¬ä¸»ç¾©ã®å¥´éš·ã‚¬ãƒãƒ£ (ãƒ¬ã‚¢)
        </button>
        <button onclick="openGacha('normal')" style="background: linear-gradient(45deg, #0ff, #00f); color: white; margin-top: 10px; font-size: 20px;">
            ãƒˆãƒ­ãƒ„ã‚­ãƒ¼ãƒ¯ã‚¯ãƒ¯ã‚¯ã‚¬ãƒãƒ£ (ãƒãƒ¼ãƒãƒ«)
        </button>
        <button onclick="" style="background: #444; color: white; margin-top: 10px; font-size: 16px;" disabled>
            æœŸé–“é™å®šã‚¬ãƒãƒ£ (é–‹ç™ºä¸­)
        </button>
        <button onclick="closeGachaSelection()" style="background: #555; font-size: 16px; margin-top: 30px;">æˆ»ã‚‹</button>
    </div>
    <div id="gacha-screen" class="hidden">
        <h1 id="gacha-title" style="color: #ffaa00;">åŒå¿—å¬å–š</h1>
        <div id="torotuki-container">
            <img id="torotuki-img" src="" alt="Target">
            <div id="pickaxe">â›ï¸</div>
        </div>
        <div id="gacha-info">
            <p id="gacha-cost-text"></p>
            <p>æ‰€æŒ: <span id="gacha-muteki-count">0</span>å€‹</p>
        </div>
        <div id="gacha-result" style="font-size: 20px; color: yellow; height: 30px;"></div>
        <button id="gacha-button" onclick="runGachaHandler()"></button>
        <button onclick="closeGacha()" style="background: #555; font-size: 16px; margin-top: 10px;">ã‚¬ãƒãƒ£é¸æŠã«æˆ»ã‚‹</button>
    </div>

    <div id="save-load-screen" class="hidden">
        <h1 style="color: #0a0;">ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã</h1>
        <p>
            ã‚»ãƒ¼ãƒ–: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ç™ºè¡Œã—ã¾ã™ã€‚<br>
            ãƒ­ãƒ¼ãƒ‰: ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã€‚
        </p>
        
        <button onclick="generateSaveCode()" style="font-size: 18px;">ã‚»ãƒ¼ãƒ– (ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ)</button>
        
        <textarea id="save-load-code" placeholder="ã“ã“ã«ç™ºè¡Œã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
        
        <button onclick="executeLoadCode()" style="background: #00f; color: white; font-size: 18px;">ãƒ­ãƒ¼ãƒ‰ (å®Ÿè¡Œ)</button>
        
        <button onclick="closeSaveLoadScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">æˆ»ã‚‹</button>
    </div>

    <div id="pause-screen" class="hidden">
        <h1 style="color: #ff0;">ä¸€æ™‚åœæ­¢</h1>
        <button onclick="togglePause()">é©å‘½ç¶šè¡Œ</button>
        <button onclick="returnToStart()" style="background: #888; color: white; margin-top: 10px; font-size: 18px;">é©å‘½ã‚’ä¸­æ–­ (ã‚¿ã‚¤ãƒˆãƒ«ã¸)</button>
    </div>

    <div id="skin-list-screen" class="hidden">
        <h1 style="color: #0ff;">åŒå¿—ä¸€è¦§</h1>
        <p>æ‰€æŒã—ã¦ã„ã‚‹åŒå¿— (ã‚¹ã‚­ãƒ³) ã¨ã€å¬å–šå¯èƒ½ãªåŒå¿—ã®ä¸€è¦§ã§ã™ã€‚</p>
        <div id="skin-list-container">
            </div>
        <button onclick="closeSkinListScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">æˆ»ã‚‹</button>
    </div>

    <div id="custom-skin-screen" class="hidden">
        <h1 style="color: #0f0;">ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—ä½œæˆ</h1>
        <p>
            ã“ã“ã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€<br>
            ã‚ãªãŸã ã‘ã®ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—ï¼ˆã‚¹ã‚­ãƒ³ï¼‰ã‚’ä½œæˆã§ãã¾ã™ã€‚
        </p>
        <p style="font-size: 16px; color: #ff0; border: 1px solid #ff0; padding: 10px; max-width: 80%;">
            <strong>æ³¨æ„:</strong><br>
            ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸåŒå¿—ã¯ã€ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã¨æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚<br>
            ãƒ»ã€Œãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ãã€æ©Ÿèƒ½ã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
            ãƒ»å¼•ãç¶™ãã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã¯ã€å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚
        </p>
        
        <input type="file" id="custom-skin-upload" accept="image/png, image/jpeg, image/gif" style="margin-top: 20px; color: white; font-size: 16px;">
        <div style="margin-top: 15px;">
            <img id="custom-skin-preview" src="" alt="Preview" style="max-width: 150px; max-height: 150px; border: 2px solid #555; background: #333; display: none;">
        </div>
        
        <button id="custom-skin-save" onclick="saveCustomSkin()" style="font-size: 18px;" disabled>ã“ã®åŒå¿—ã§æ±ºå®š</button>
        <button onclick="closeCustomSkinScreen()" style="background: #555; font-size: 16px; margin-top: 10px;">æˆ»ã‚‹</button>
    </div>


    <audio id="bgm-player" src="bgm.mp3" loop preload="auto"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ==========================================
        // è¨­å®šãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ==========================================
        let scene, camera, renderer;
        let player, playerTexture, textureLoader;
        let clock, delta;
        let isPlaying = false;
        let isPaused = false; 
        let score = 0;
        let speed = 15;
        let distance = 0; // èµ°è¡Œè·é›¢
        let highScore = 0; 
        let highDistance = 0; 

        // â–¼â–¼â–¼ è¿½åŠ  (è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆç”¨) â–¼â–¼â–¼
        let isAwakeningUnlocked = false; 
        const AWAKENING_UNLOCK_COST = 200;
        const AWAKENING_START_DISTANCE = 5000;
        const AWAKENING_START_SPEED = 47; // 5000måˆ°é”æ™‚ã®æƒ³å®šã‚¹ãƒ”ãƒ¼ãƒ‰ (è¨ˆç®—å€¤)
        const AWAKENING_START_SCORE = 5000; // è·é›¢ã¨åˆã‚ã›ã‚‹
        // â–²â–²â–² è¿½åŠ  â–²â–²â–²

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let mutekiBalls = 0;
        let currentSkin = 'player.png';
        let ownedSkins = new Set(['player.png']); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚­ãƒ³
        const NORMAL_GACHA_COST = 10; // â–¼ å¤‰æ›´: ãƒˆãƒ­ãƒ„ã‚­ãƒ¼ãƒ¯ã‚¯ãƒ¯ã‚¯ã‚¬ãƒãƒ£ã®ã‚³ã‚¹ãƒˆ
        const RARE_GACHA_COST = 20; // â–¼ è¿½åŠ : è³‡æœ¬ä¸»ç¾©ã®å¥´éš·ã‚¬ãƒãƒ£ã®ã‚³ã‚¹ãƒˆ
        let currentGachaType = 'normal'; // â–¼ è¿½åŠ : ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ã‚¬ãƒãƒ£ã®ç¨®é¡ ('normal' or 'rare')

        const SKIN_LIST = [
            'player.png', 'player2.jpg', 'player3.jpg', 'player4.jpg', 'player5.jpg', 'player6.jpg', 'player7.jpg', 'player8.jpg', 'player9.jpg', 'player10.jpg', 'player11.jpg', 'player12.jpg', 'player13.jpg', 'player14.jpg', 'player15.jpg', 'player16.jpg', 'player17.jpg', 'player18.png'
        ];
        const SAVE_DATA_KEY = 'revolutionRunData';

        // â–¼â–¼â–¼ è¿½åŠ /å¤‰æ›´ (ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ç”¨) â–¼â–¼â–¼
        const CUSTOM_SKIN_ID = 'custom_skin.png'; // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®å†…éƒ¨ID
        const CUSTOM_SKIN_KEY = 'revolutionRunCustomSkin'; // localStorageã‚­ãƒ¼ (DataURL)
        const CUSTOM_SKIN_TYPE_KEY = 'revolutionRunCustomSkinType'; // ( 'static' or 'gif' )
        let customSkinDataURL = null; // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®Data URLã‚’ä¿æŒ
        let isCustomSkinAnimated = false; // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãŒGIFã‹ã©ã†ã‹
        let customSkinGifElement; // GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã® <img> è¦ç´ 
        // â–²â–²â–² è¿½åŠ /å¤‰æ›´ â–²â–²â–²

        // ãƒ¬ãƒ¼ãƒ³è¨­å®š
        let currentLane = 0; 
        const LANE_WIDTH = 3.0; 
        let targetX = 0;

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let isJumping = false;
        let isCrouching = false;
        let jumpVelocity = 0;
        let gravity = -35;
        let crouchTimer = 0;

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
        let obstacles = [];
        let lastObstacleTypes = []; // éšœå®³ç‰©ç”Ÿæˆã®å±¥æ­´
        
        // ç”»åƒãƒ‘ã‚¹ (ã‚¬ãƒãƒ£ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç”»åƒ)
        const TOROTUKI_IMG_SRC = 'torotuki.jpg';
        const BERLIN_WALL_IMG_SRC = 'BerlinWall.jpg'; // â–¼ è¿½åŠ : ãƒ¬ã‚¢ã‚¬ãƒãƒ£ç”¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç”»åƒ

        // BGMç”¨
        const DEFAULT_BGM_SRC = 'bgm.mp3'; // â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆBGMã®ãƒ‘ã‚¹
        let bgmElement;
        let isBGMEnabled = false; 
        const BGM_SAVE_KEY = 'revolutionRunBGM';

        // ã‚¬ãƒãƒ£ç”¨ãƒ¬ã‚¢ã‚¹ã‚­ãƒ³
        const RARE_SKINS = [
            { name: 'fuziwara.jpg', rate: 0.005, rarity: "è¶…çµ¶é©å‘½" }, // 0.5%
            { name: 'kora_torotuki.png', rate: 0.005, rarity: "è¶…çµ¶é©å‘½" }, // 0.5%
            { name: 'sonbun.jpg', rate: 0.01, rarity: "è¶…é©å‘½çš„" }, // 1%
            { name: 'poru.jpg', rate: 0.01, rarity: "è¶…é©å‘½çš„" }, // 1%
            { name: 'ejof.png', rate: 0.01, rarity: "è¶…é©å‘½çš„" }, 
            { name: 'matoryo.png', rate: 0.1, rarity: "è¶…é©å‘½çš„" }, // 10%
            { name: TOROTUKI_IMG_SRC, rate: 0.01, rarity: "é©å‘½çš„" } // 1% (å…ƒã®1%)
        ];

        // ==========================================
        // åˆæœŸåŒ–ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        // ==========================================
        function init() {
            textureLoader = new THREE.TextureLoader(); 
            
            // ã‚·ãƒ¼ãƒ³
            scene = new THREE.Scene();
            
            // â˜…å¤‰æ›´: èƒŒæ™¯ç”»åƒã®èª­ã¿è¾¼ã¿ (kremlin.jpg)
            // ãƒ•ã‚©ã‚°ã¨ãƒ–ãƒ¬ãƒ³ãƒ‰ã•ã›ãšã€èƒŒæ™¯ã«å›ºå®šè¡¨ç¤ºã•ã›ã‚‹
            textureLoader.load('kremlin.jpg', function(texture) {
                scene.background = texture;
            }, undefined, function(err) {
                // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                console.log("èƒŒæ™¯ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—ã€å˜è‰²ã«ã—ã¾ã™");
                scene.background = new THREE.Color(0x110022);
            });

            scene.fog = new THREE.FogExp2(0x110022, 0.02);

            // ã‚«ãƒ¡ãƒ©
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 9, 12);
            camera.lookAt(0, 0, -5);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // ãƒ©ã‚¤ãƒˆ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // åºŠ
            const gridHelper = new THREE.GridHelper(200, 100, 0xff0055, 0x222222);
            gridHelper.position.y = 0;
            scene.add(gridHelper);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆ
            createPlayer();

            // â–¼â–¼â–¼ è¿½åŠ /å¤‰æ›´ â–¼â–¼â–¼
            setupCustomSkinUploader();
            setupBGMUploader(); // â˜…BGMã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
            customSkinGifElement = document.getElementById('custom-skin-gif-source');
            // â–²â–²â–² è¿½åŠ /å¤‰æ›´ â–²â–²â–²

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            window.addEventListener('resize', onWindowResize);
            setupInputs(); 

            // BGMã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            bgmElement = document.getElementById('bgm-player');
            loadBGMSetting(); 
            updateBGMButtonUI();
            bgmElement.muted = true; 

            // â˜…ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            loadData(); // ã“ã®ä¸­ã§ã‚¹ã‚­ãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼UIã¨ãƒã‚¤ã‚¹ã‚³ã‚¢UIã¨è¦šé†’UIãŒæ›´æ–°ã•ã‚Œã‚‹

            // ãƒ«ãƒ¼ãƒ—é–‹å§‹
            clock = new THREE.Clock();
            animate();
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
        function createPlayer() {
            const geometry = new THREE.PlaneGeometry(1.5, 1.5);
            const material = new THREE.MeshBasicMaterial({ 
                map: null, 
                transparent: true, 
                side: THREE.DoubleSide 
            });
            player = new THREE.Mesh(geometry, material);
            player.position.y = 0.75;
            scene.add(player);
            applySkin(currentSkin);
        }

        // â–¼â–¼â–¼ å¤‰æ›´ (GIFå¯¾å¿œã®ãŸã‚ applySkin ã‚’å¤§å¹…ã«å¤‰æ›´) â–¼â–¼â–¼
        // ã‚¹ã‚­ãƒ³ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        function applySkin(skinName) {
            
            const onTextureError = (err) => {
                console.error('ã‚¹ã‚­ãƒ³ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—:', skinName, err);
                if (player) {
                    player.material.map = createPlaceholderTexture('#ffffff');
                    player.material.needsUpdate = true;
                }
            };

            if (skinName === CUSTOM_SKIN_ID) {
                // --- ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®å ´åˆ ---
                if (isCustomSkinAnimated && customSkinDataURL) {
                    // 1. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³GIF ã®å ´åˆ
                    try {
                        // <img> è¦ç´ ã®srcã‚’ã‚»ãƒƒãƒˆ
                        if (customSkinGifElement.src !== customSkinDataURL) {
                            customSkinGifElement.src = customSkinDataURL;
                        }
                        
                        // <img> è¦ç´ ã‹ã‚‰æ–°ã—ã„Textureã‚’ä½œæˆ
                        const gifTexture = new THREE.Texture(customSkinGifElement);
                        gifTexture.needsUpdate = true; // æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        
                        if (player) {
                            player.material.map = gifTexture;
                            player.material.needsUpdate = true;
                        }
                        currentSkin = skinName;

                    } catch (e) {
                        onTextureError(e);
                    }
                } else if (customSkinDataURL) {
                    // 2. é™æ­¢ç”» (PNG/JPG) ã®å ´åˆ
                    textureLoader.load(customSkinDataURL, 
                        (tex) => {
                            if (player) {
                                player.material.map = tex;
                                player.material.needsUpdate = true;
                            }
                            currentSkin = skinName; 
                        },
                        undefined, 
                        onTextureError
                    );
                } else {
                    // 3. ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã¦ã„ã‚‹å ´åˆ
                    console.warn("ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã€‚");
                    applySkin('player.png'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚­ãƒ³ã‚’é©ç”¨
                    currentSkin = 'player.png'; // currentSkinã‚‚ãƒªã‚»ãƒƒãƒˆ
                    return;
                }
            } else {
                // --- é€šå¸¸ã®ã‚¹ã‚­ãƒ³ã®å ´åˆ ---
                textureLoader.load(skinName, 
                    (tex) => {
                        if (player) {
                            player.material.map = tex;
                            player.material.needsUpdate = true;
                        }
                        currentSkin = skinName; 
                    },
                    undefined, 
                    onTextureError
                );
            }
        }
        // â–²â–²â–² å¤‰æ›´ â–²â–²â–²

        // ç”»åƒãŒãªã„å ´åˆã®ä»£æ›¿ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”Ÿæˆ
        function createPlaceholderTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.arc(64, 64, 60, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'black';
            ctx.fillRect(40, 45, 15, 25); ctx.fillRect(73, 45, 15, 25);
            ctx.beginPath(); ctx.arc(64, 85, 20, 0, Math.PI, false); ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        // ã€Œç„¡æ•µã€ãƒœãƒ¼ãƒ«ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ç”Ÿæˆ
        function createMutekiTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
            ctx.beginPath(); ctx.arc(64, 64, 64, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ç„¡æ•µ', 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        // ==========================================
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            delta = clock.getDelta();

            if (isPlaying && !isPaused) {
                updateGame(delta);
            }
            
            // â–¼â–¼â–¼ è¿½åŠ  (GIFã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ›´æ–°) â–¼â–¼â–¼
            if (currentSkin === CUSTOM_SKIN_ID && isCustomSkinAnimated && player.material.map) {
                // GIFãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–°
                player.material.map.needsUpdate = true;
            }
            // â–²â–²â–² è¿½åŠ  â–²â–²â–²

            renderer.render(scene, camera);
        }

        function updateGame(dt) {
            speed += dt * 0.2;
            score += Math.floor(speed * dt);
            distance += speed * dt; // èµ°è¡Œè·é›¢ã‚’åŠ ç®—
            
            // UIæ›´æ–°
            document.getElementById('score-val').innerText = score;
            document.getElementById('distance-val').innerText = Math.floor(distance);

            player.position.x += (targetX - player.position.x) * 10 * dt;

            if (isJumping) {
                player.position.y += jumpVelocity * dt;
                jumpVelocity += gravity * dt;

                if (isCrouching) {
                    player.scale.y = THREE.MathUtils.lerp(player.scale.y, 0.5, 15 * dt);
                    if (player.position.y <= 0.375) { 
                        player.position.y = 0.375;
                        isJumping = false;
                        jumpVelocity = 0;
                    }
                } else {
                    player.scale.y = THREE.MathUtils.lerp(player.scale.y, 1.0, 15 * dt);
                    if (player.position.y <= 0.75) {
                        player.position.y = 0.75;
                        isJumping = false;
                        jumpVelocity = 0;
                    }
                }
            
            } else if (isCrouching) {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 0.5, 15 * dt);
                player.position.y = 0.375;
                crouchTimer -= dt; 
                if (crouchTimer <= 0) { 
                    isCrouching = false;
                }

            } else {
                player.scale.y = THREE.MathUtils.lerp(player.scale.y, 1.0, 15 * dt);
                player.position.y = 0.75;
            }

            player.lookAt(camera.position);

            if (Math.random() < 0.05) {
                spawnObstacle();
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obj = obstacles[i];
                obj.position.z += speed * dt;

                if (obj.userData.type === 'ball') {
                    obj.rotation.y += 5 * dt;
                    obj.rotation.x += 2 * dt;
                }

                if (Math.abs(obj.position.z - player.position.z) < 0.8) {
                    if (Math.abs(obj.position.x - player.position.x) < 1.0) {
                        checkCollision(obj, i);
                    }
                }

                if (obj.position.z > 5) {
                    scene.remove(obj);
                    obstacles.splice(i, 1);
                }
            }
        }

        // ==========================================
        // éšœå®³ç‰©ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
        // ==========================================
        function spawnObstacle() {
            if (obstacles.length > 0) {
                const lastObj = obstacles[obstacles.length - 1];
                if (lastObj.position.z > -25) return;
            }

            const laneIndex = Math.floor(Math.random() * 3) - 1; // -1, 0, 1
            const posX = laneIndex * LANE_WIDTH;
            let typeRand = Math.random();

            // 3é€£ç¶šã§ç´«ã®å£(pillar)ãŒå‡ºç¾ã™ã‚‹ã®ã‚’é˜²ã
            if (lastObstacleTypes.length === 2 && lastObstacleTypes.every(t => t === 'pillar')) {
                typeRand = Math.random() * 0.7; // pillarã§ãªã„éšœå®³ç‰©ã‚’å¼·åˆ¶çš„ã«ç”Ÿæˆ
            }

            let mesh;
            let type = '';

            if (typeRand < 0.2) {
                const geometry = new THREE.SphereGeometry(0.5, 16, 16);
                const material = new THREE.MeshBasicMaterial({ map: createMutekiTexture() });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.5, -50);
                type = 'ball';
            } else if (typeRand < 0.5) {
                const geometry = new THREE.BoxGeometry(2.5, 1.2, 0.5);
                const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 0.6, -50);
                type = 'wall';
            } else if (typeRand < 0.7) {
                const geometry = new THREE.CylinderGeometry(1.5, 1.5, 1.0, 16, 1, true, 0, Math.PI);
                const material = new THREE.MeshStandardMaterial({ color: 0x888888, side: THREE.DoubleSide });
                mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.z = Math.PI / 2; 
                mesh.rotation.y = Math.PI / 2;
                mesh.position.set(posX, 0.5, -50);
                type = 'tunnel';
            } else {
                const geometry = new THREE.BoxGeometry(1, 4, 1);
                const material = new THREE.MeshStandardMaterial({ color: 0x5500aa });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(posX, 2, -50);
                type = 'pillar';
            }

            // å±¥æ­´ã‚’æ›´æ–°
            lastObstacleTypes.push(type);
            if (lastObstacleTypes.length > 2) {
                lastObstacleTypes.shift();
            }

            mesh.userData = { type: type, isObstacle: true };
            scene.add(mesh);
            obstacles.push(mesh);
        }

        // ==========================================
        // å½“ãŸã‚Šåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        // ==========================================
        function checkCollision(obj, index) {
            const type = obj.userData.type;

            if (type === 'ball') {
                mutekiBalls++;
                score += 1000;
                updateMutekiCountUI();
                updateAwakeningUI(); 
                saveData(); 
                scene.remove(obj);
                obstacles.splice(index, 1);
            } else if (type === 'wall') {
                if (player.position.y < 1.2) {
                    gameOver();
                }
            } else if (type === 'tunnel') {
                if (!isCrouching) {
                    gameOver();
                }
            } else if (type === 'pillar') {
                gameOver();
            }
        }

        // ç„¡æ•µãƒœãƒ¼ãƒ«ã®UIã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateMutekiCountUI() {
            document.getElementById('muteki-count').innerText = `ç„¡æ•µãƒœãƒ¼ãƒ«: ${mutekiBalls}å€‹`;
        }

        // ==========================================
        // å…¥åŠ›å‡¦ç† (ã‚¹ãƒãƒ›ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾å¿œ)
        // ==========================================
        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (!isPlaying) return;

                if (e.code === 'KeyP' || e.code === 'Escape') {
                    togglePause();
                    return; 
                }
                if (isPaused) return; 

                if (e.code === 'ArrowLeft') moveLane(-1);
                if (e.code === 'ArrowRight') moveLane(1);
                if (e.code === 'ArrowUp') doJump();
                if (e.code === 'ArrowDown') doCrouch();
            });

            let touchStartX = 0;
            let touchStartY = 0;

            document.addEventListener('touchstart', (e) => {
                if (!isPlaying || isPaused) return; 
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchend', (e) => {
                if (!isPlaying || isPaused) return;
                let touchEndX = e.changedTouches[0].clientX;
                let touchEndY = e.changedTouches[0].clientY;
                let diffX = touchEndX - touchStartX;
                let diffY = touchEndY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 30) {
                        if (diffX > 0) moveLane(1);
                        else moveLane(-1);
                    }
                } 
                else {
                    if (Math.abs(diffY) > 30) {
                        if (diffY < 0) doJump();
                        else doCrouch();
                    }
                }
            }, false);
        }

        function moveLane(dir) {
            currentLane += dir;
            if (currentLane < -1) currentLane = -1;
            if (currentLane > 1) currentLane = 1;
            targetX = currentLane * LANE_WIDTH;
        }

        function doJump() {
            if (!isJumping) {
                isJumping = true;
                jumpVelocity = 12;
            }
        }

        function doCrouch() {
            if (isJumping) {
                if (jumpVelocity > -15) { 
                    jumpVelocity = -25;
                }
            } else { 
                isCrouching = true;
                crouchTimer = 0.8; 
            }
        }

        // ==========================================
        // ã‚²ãƒ¼ãƒ é€²è¡Œç®¡ç†
        // ==========================================

        function togglePause() {
            if (!isPlaying) return; 

            isPaused = !isPaused;
            const pauseScreen = document.getElementById('pause-screen');

            if (isPaused) {
                pauseScreen.classList.remove('hidden');
                if (bgmElement) {
                    bgmElement.pause(); 
                }
            } else {
                pauseScreen.classList.add('hidden');
                playBGM(); 
            }
        }

        function returnToStart() {
            document.getElementById('pause-screen').classList.add('hidden');
            document.getElementById('pause-button').classList.add('hidden');
            
            isPlaying = false;
            isPaused = false;
            
            if (bgmElement) {
                bgmElement.pause();
                bgmElement.currentTime = 0; 
            }

            document.getElementById('start-screen').classList.remove('hidden');
            
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            
            resetGameVals();
            updateSkinSelectorUI();
            updateHighScoreUI(); 
            updateAwakeningUI(); 
        }


        function startGame(isAwakening = false) { 
            document.getElementById('start-screen').classList.add('hidden');
            resetGameVals(isAwakening); 
            isPlaying = true;
            playBGM(); 
            document.getElementById('pause-button').classList.remove('hidden'); 
        }

        function gameOver() {
            isPlaying = false;
            document.getElementById('pause-button').classList.add('hidden'); 
            
            if (score > highScore) {
                highScore = score;
            }
            const finalDist = Math.floor(distance);
            if (finalDist > highDistance) {
                highDistance = finalDist;
            }
            saveData(); 
            updateHighScoreUI();
            updateAwakeningUI(); 
            
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-distance').innerText = finalDist;
            updateSkinSelectorUI();
        }

        function resetGame(isAwakening = false) { 
            document.getElementById('game-over-screen').classList.add('hidden');
            resetGameVals(isAwakening); 
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];
            isPlaying = true;
            playBGM(); 
            document.getElementById('pause-button').classList.remove('hidden'); 
        }

        function resetGameVals(isAwakening = false) { 
            if (isAwakening) {
                score = AWAKENING_START_SCORE;
                speed = AWAKENING_START_SPEED;
                distance = AWAKENING_START_DISTANCE;
            } else {
                score = 0;
                speed = 15;
                distance = 0; 
            }
            
            currentLane = 0;
            targetX = 0;
            player.position.x = 0;
            
            isJumping = false;
            isCrouching = false;
            isPaused = false; 
            jumpVelocity = 0;
            crouchTimer = 0;
            
            document.getElementById('score-val').innerText = score;
            document.getElementById('distance-val').innerText = Math.floor(distance);
            updateMutekiCountUI();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==========================================
        // BGMç®¡ç† & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (â˜…å¤‰æ›´ç®‡æ‰€)
        // ==========================================

        function setupBGMUploader() {
            const input = document.getElementById('bgm-upload-input');
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’ç”Ÿæˆã—ã¦BGMã‚½ãƒ¼ã‚¹ã«è¨­å®š
                    const objectUrl = URL.createObjectURL(file);
                    bgmElement.src = objectUrl;
                    
                    // å¼·åˆ¶çš„ã«ONã«ã™ã‚‹
                    isBGMEnabled = true;
                    updateBGMButtonUI();
                    playBGM();
                    
                    alert("BGMã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼(â€»å†èª­ã¿è¾¼ã¿ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™)");
                }
                // inputå€¤ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                input.value = '';
            });
        }

        function triggerBGMUpload() {
            document.getElementById('bgm-upload-input').click();
        }

        function resetDefaultBGM() {
            bgmElement.src = DEFAULT_BGM_SRC;
            alert("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®BGMã«æˆ»ã—ã¾ã—ãŸã€‚");
            if (isBGMEnabled) {
                playBGM();
            }
        }

        function playBGM() {
            if (isBGMEnabled && bgmElement && !isPaused) {
                bgmElement.muted = false; 
                const promise = bgmElement.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.warn("BGMã®è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚", error);
                        isBGMEnabled = false; 
                        bgmElement.muted = true;
                        saveBGMSetting();
                        updateBGMButtonUI();
                    });
                }
            }
        }

        function toggleBGM() {
            isBGMEnabled = !isBGMEnabled;
            
            if (isBGMEnabled) {
                playBGM(); 
            } else {
                bgmElement.pause(); 
                bgmElement.muted = true;
            }
            
            saveBGMSetting();
            updateBGMButtonUI();
        }

        function updateBGMButtonUI() {
            const text = isBGMEnabled ? "BGM: ON" : "BGM: OFF";
            const color = isBGMEnabled ? "linear-gradient(45deg, #0f0, #0a0)" : "#444"; 
            
            const btn1 = document.getElementById('bgm-toggle-start');
            if (btn1) {
                btn1.innerText = text;
                btn1.style.background = color;
            }
            
            const btn2 = document.getElementById('bgm-toggle-over');
            if (btn2) {
                btn2.innerText = text;
                btn2.style.background = color;
            }
        }

        function saveBGMSetting() {
            try {
                localStorage.setItem(BGM_SAVE_KEY, JSON.stringify({ enabled: isBGMEnabled }));
            } catch (e) {
                console.error("BGMè¨­å®šã®ä¿å­˜ã«å¤±æ•—", e);
            }
        }

        function loadBGMSetting() {
            try {
                const setting = localStorage.getItem(BGM_SAVE_KEY);
                if (setting) {
                    isBGMEnabled = JSON.parse(setting).enabled || false;
                }
            } catch (e) {
                console.error("BGMè¨­å®šã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—", e);
                isBGMEnabled = false;
            }
        }

        // ==========================================
        // ã‚¹ã‚­ãƒ³é¸æŠã‚·ã‚¹ãƒ†ãƒ 
        // ==========================================

        function updateSkinSelectorUI() {
            const selectors = document.querySelectorAll('.skin-selector');
            if (selectors.length === 0) return;

            selectors.forEach(selector => {
                selector.innerHTML = ''; 
                ownedSkins.forEach(skinName => {
                    const option = document.createElement('option');
                    option.value = skinName;
                    
                    if (skinName === CUSTOM_SKIN_ID) {
                        option.innerText = 'ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—';
                    } else {
                        option.innerText = skinName.replace('.png', '').replace('.jpg', ''); 
                    }

                    if (skinName === currentSkin) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            });
        }

        function changeSkin(skinName) {
            if (ownedSkins.has(skinName)) {
                applySkin(skinName);
                saveData(); 
                console.log(`ã‚¹ã‚­ãƒ³ã‚’ ${skinName} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
                updateSkinSelectorUI();
            }
        }

        // ==========================================
        // ã‚¬ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ  (å¤§æ”¹ä¿®)
        // ==========================================

        // â–¼ è¿½åŠ : ã‚¬ãƒãƒ£é¸æŠç”»é¢ã®è¡¨ç¤º
        function openGachaSelection() {
            document.getElementById('gacha-selection-screen').classList.remove('hidden');
            document.getElementById('gacha-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
        }

        // â–¼ è¿½åŠ : ã‚¬ãƒãƒ£é¸æŠç”»é¢ã‚’é–‰ã˜ã‚‹
        function closeGachaSelection() {
            document.getElementById('gacha-selection-screen').classList.add('hidden');
            if (isPlaying || isPaused) {
                document.getElementById('pause-screen').classList.remove('hidden');
            } else {
                document.getElementById('start-screen').classList.remove('hidden');
            }
        }

        // â–¼ å¤‰æ›´: é¸æŠã•ã‚ŒãŸã‚¬ãƒãƒ£ç”»é¢ã®è¡¨ç¤º
        function openGacha(type) {
            currentGachaType = type;
            document.getElementById('gacha-selection-screen').classList.add('hidden');
            document.getElementById('gacha-screen').classList.remove('hidden');
            
            document.getElementById('gacha-result').innerText = "";
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls;
            
            updateGachaScreen(type);
        }

        // â–¼ è¿½åŠ : ã‚¬ãƒãƒ£ç”»é¢ã®UIã‚’æ›´æ–°
        function updateGachaScreen(type) {
            const img = document.getElementById('torotuki-img');
            const gachaButton = document.getElementById('gacha-button');
            const pickaxe = document.getElementById('pickaxe');
            const gachaTitle = document.getElementById('gacha-title');
            const gachaCostText = document.getElementById('gacha-cost-text');
            let cost = 0;

            pickaxe.style.opacity = '0';
            pickaxe.style.transform = 'translate(0, 0) rotate(0deg)';

            if (type === 'normal') {
                cost = NORMAL_GACHA_COST;
                gachaTitle.innerText = "ãƒˆãƒ­ãƒ„ã‚­ãƒ¼ãƒ¯ã‚¯ãƒ¯ã‚¯ã‚¬ãƒãƒ£";
                img.src = TOROTUKI_IMG_SRC;
                gachaButton.innerText = `ãƒ”ãƒƒã‚±ãƒ«æŠ•æ“² (${cost}å€‹æ¶ˆè²»)`;
                // â–¼ ä¿®æ­£: ãƒ¬ã‚¢åŒå¿—ãŒå‡ºãªã„ã“ã¨ã‚’æ˜è¨˜
                gachaCostText.innerHTML = `1å›: ç„¡æ•µãƒœãƒ¼ãƒ« ${cost}å€‹<br>ä¸€èˆ¬åŒå¿—`;
                gachaButton.onclick = runNormalGacha;
            } else if (type === 'rare') {
                cost = RARE_GACHA_COST;
                gachaTitle.innerText = "è³‡æœ¬ä¸»ç¾©ã®å¥´éš·ã‚¬ãƒãƒ£";
                img.src = BERLIN_WALL_IMG_SRC; // æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç”»åƒ
                gachaButton.innerText = `ãƒ”ãƒƒã‚±ãƒ«æŠ•æ“² (${cost}å€‹æ¶ˆè²»)`;
                gachaCostText.innerHTML = `1å›: ç„¡æ•µãƒœãƒ¼ãƒ« ${cost}å€‹<br><span style="color: #f00;">ãƒ¬ã‚¢åŒå¿—ä»¥å¤–ã¯è™šç„¡ï¼ˆä½•ã‚‚å¾—ã‚‰ã‚Œãªã„ï¼‰</span>`;
                gachaButton.onclick = runRareGacha;
            } else {
                // ã“ã“ã«ã¯æ¥ãªã„æƒ³å®š
                return;
            }

            // ç”»åƒã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (å†è¨­å®š)
            img.onerror = function() {
                const c = document.createElement('canvas');
                c.width = 200; c.height = 200;
                const x = c.getContext('2d');
                x.fillStyle = '#ccc'; x.fillRect(0,0,200,200);
                x.fillStyle = '#000'; x.font = '30px Arial'; x.textAlign = 'center';
                x.fillText('Target', 100, 100);
                img.src = c.toDataURL();
            };

            gachaButton.disabled = (mutekiBalls < cost);
        }

        // â–¼ å¤‰æ›´: ã‚¬ãƒãƒ£ç”»é¢ã‹ã‚‰é¸æŠç”»é¢ã¸æˆ»ã‚‹
        function closeGacha() {
            document.getElementById('gacha-screen').classList.add('hidden');
            openGachaSelection(); // ã‚¬ãƒãƒ£é¸æŠç”»é¢ã«æˆ»ã‚‹
        }

        // â–¼ å¤‰æ›´: runGachaã‚’å‰Šé™¤ã—ã€runGachaHandlerã§åˆ†å²
        function runGachaHandler() {
            if (currentGachaType === 'normal') {
                runNormalGacha();
            } else if (currentGachaType === 'rare') {
                runRareGacha();
            }
        }

        // â–¼ è¿½åŠ : ãƒãƒ¼ãƒãƒ«ã‚¬ãƒãƒ£ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ (ãƒ¬ã‚¢æ’å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤)
        function runNormalGacha() {
            const cost = NORMAL_GACHA_COST;
            if (mutekiBalls < cost) {
                document.getElementById('gacha-result').innerText = "ç„¡æ•µãƒœãƒ¼ãƒ«ãŒè¶³ã‚Šã¾ã›ã‚“ï¼";
                return;
            }

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = true;

            mutekiBalls -= cost;
            updateMutekiCountUI(); 
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls; 
            updateAwakeningUI(); 
            
            const pickaxe = document.getElementById('pickaxe');
            const imgContainer = document.getElementById('torotuki-container');
            
            pickaxe.style.opacity = '1';
            pickaxe.style.top = '-50px';
            pickaxe.style.right = '-50px';
            
            setTimeout(() => {
                pickaxe.style.transform = 'translate(-80px, 80px) rotate(-45deg)'; 
                
                setTimeout(() => {
                    imgContainer.classList.add('shake');
                    
                    setTimeout(() => {
                        imgContainer.classList.remove('shake');
                        
                        let newSkin = "";
                        let resultText = "";
                        
                        // ãƒ¬ã‚¢ã‚¹ã‚­ãƒ³ï¼ˆãƒˆãƒ­ãƒ„ã‚­ãƒ¼ï¼‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚
                        // å¸¸ã«ãƒãƒ¼ãƒãƒ«ã‚¹ã‚­ãƒ³ã®ã¿ã‚’æŠ½é¸ã—ã¾ã™ã€‚

                        // æœªæ‰€æŒã®ãƒãƒ¼ãƒãƒ«ã‚¹ã‚­ãƒ³ã‚’æ¢ã™
                        const availableNormalSkins = SKIN_LIST.filter(s => !ownedSkins.has(s) && s !== CUSTOM_SKIN_ID && s !== TOROTUKI_IMG_SRC);
                        
                        if (availableNormalSkins.length > 0) {
                            // æœªæ‰€æŒã®ãƒãƒ¼ãƒãƒ«ã‚¹ã‚­ãƒ³ãŒã‚ã‚Œã°ç¢ºå®šæ’å‡º
                            newSkin = availableNormalSkins[Math.floor(Math.random() * availableNormalSkins.length)];
                            ownedSkins.add(newSkin);
                            updateSkinSelectorUI(); 
                            resultText = `æ–°è¦åŒå¿— [${newSkin}] ã‚’å¬å–šï¼`;
                        } else {
                            // å…¨ã¦æ‰€æŒã—ã¦ã„ã‚Œã°ã€ãƒ©ãƒ³ãƒ€ãƒ ã§å†æ’å‡º
                            // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã¨ãƒ¬ã‚¢åˆ¤å®šç”»åƒã‚’é™¤å¤–ã—ãŸãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶
                            const allNormalSkins = SKIN_LIST.filter(s => s !== CUSTOM_SKIN_ID && s !== TOROTUKI_IMG_SRC);
                            newSkin = allNormalSkins[Math.floor(Math.random() * allNormalSkins.length)];
                            resultText = `åŒå¿— [${newSkin}] ã¯æ—¢ã«æ‰€æŒã—ã¦ã„ã¾ã™`;
                        }
                        
                        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: innerText -> innerHTML â˜…â˜…â˜…
                        document.getElementById('gacha-result').innerHTML = resultText;
                        saveData();

                        if (mutekiBalls >= cost) {
                            gachaButton.disabled = false;
                        }

                    }, 500);
                }, 300);
            }, 100);
        }
        
        // â–¼ è¿½åŠ : ãƒ¬ã‚¢ã‚¬ãƒãƒ£ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
        function runRareGacha() {
            const cost = RARE_GACHA_COST;
            if (mutekiBalls < cost) {
                document.getElementById('gacha-result').innerText = "ç„¡æ•µãƒœãƒ¼ãƒ«ãŒè¶³ã‚Šã¾ã›ã‚“ï¼";
                return;
            }

            const gachaButton = document.getElementById('gacha-button');
            gachaButton.disabled = true;

            mutekiBalls -= cost;
            updateMutekiCountUI(); 
            document.getElementById('gacha-muteki-count').innerText = mutekiBalls; 
            updateAwakeningUI();
            
            const pickaxe = document.getElementById('pickaxe');
            const imgContainer = document.getElementById('torotuki-container');
            
            pickaxe.style.opacity = '1';
            pickaxe.style.top = '-50px';
            pickaxe.style.right = '-50px';
            
            setTimeout(() => {
                pickaxe.style.transform = 'translate(-80px, 80px) rotate(-45deg)'; 
                
                setTimeout(() => {
                    imgContainer.classList.add('shake');
                    
                    setTimeout(() => {
                        imgContainer.classList.remove('shake');
                        
                        let newSkin = "";
                        let resultText = "";
                        let hit = false;
                        const rand = Math.random();
                        let cumulativeRate = 0.0;
                        
                        // â˜…ä¿®æ­£â˜…: ãƒˆãƒ­ãƒ„ã‚­ãƒ¼(torotuki)ã‚’é™¤å¤–ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ã‚’å‰Šé™¤ã—ã€æ’å‡ºå¯èƒ½ã«ã—ã¾ã—ãŸã€‚
                        // const rareSkinsExcludingTrotsky = RARE_SKINS.filter(s => s.name !== TOROTUKI_IMG_SRC); 

                        // ãƒ¬ã‚¢ã‚¹ã‚­ãƒ³åˆ¤å®š
                        for (const rare of RARE_SKINS) { // å…¨ã¦ã®ãƒ¬ã‚¢ã‚¹ã‚­ãƒ³ã‹ã‚‰åˆ¤å®š
                            cumulativeRate += rare.rate;
                            if (rand < cumulativeRate) {
                                newSkin = rare.name;
                                if (ownedSkins.has(newSkin)) {
                                    resultText = `â˜…${rare.rarity}!!â˜… [${newSkin}] ã¯æ—¢ã«æ‰€æŒã—ã¦ã„ã¾ã™`;
                                } else {
                                    ownedSkins.add(newSkin);
                                    updateSkinSelectorUI(); 
                                    resultText = `<span style="color: #f0f;">â˜…â˜…â˜…${rare.rarity}åŒå¿— [${newSkin}] ã‚’å¬å–š!!!â˜…â˜…â˜…</span>`;
                                }
                                hit = true;
                                break; 
                            }
                        }

                        // è™šç„¡åˆ¤å®š (ãƒ¬ã‚¢ã‚¹ã‚­ãƒ³ã«ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆ)
                        if (!hit) {
                            resultText = `<span style="color: #aaa;">è™šç„¡... è³‡æœ¬ä¸»ç¾©ã®å¥´éš·ã‹ã‚‰ã¯ä½•ã‚‚å¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ...</span>`;
                        }
                        
                        document.getElementById('gacha-result').innerHTML = resultText;
                        saveData();

                        if (mutekiBalls >= cost) {
                            gachaButton.disabled = false;
                        }

                    }, 500);
                }, 300);
            }, 100);
        }
        // â–² è¿½åŠ  â–²

        // ==========================================
        // â˜…â˜…â˜… ã‚¹ã‚­ãƒ³ä¸€è¦§ & ãƒã‚¤ã‚¹ã‚³ã‚¢UI â˜…â˜…â˜…
        // ==========================================

        function updateHighScoreUI() {
            const hsStart = document.getElementById('high-score-start');
            const hdStart = document.getElementById('high-distance-start');
            const hsOver = document.getElementById('high-score-over');
            const hdOver = document.getElementById('high-distance-over');
            
            if (hsStart) hsStart.innerText = highScore;
            if (hdStart) hdStart.innerText = highDistance;
            if (hsOver) hsOver.innerText = highScore;
            if (hdOver) hdOver.innerText = highDistance;
        }

        function openSkinListScreen() {
            document.getElementById('skin-list-screen').classList.remove('hidden');
            populateSkinList();
        }

        function closeSkinListScreen() {
            document.getElementById('skin-list-screen').classList.add('hidden');
        }

        function populateSkinList() {
            const container = document.getElementById('skin-list-container');
            container.innerHTML = ''; 
            
            const defaultSkin = 'player.png';
            const rareSkinNames = RARE_SKINS.map(s => s.name);
            const normalSkinNames = SKIN_LIST.filter(s => s !== defaultSkin && !rareSkinNames.includes(s) && s !== CUSTOM_SKIN_ID);

            let html = '';
            
            if (ownedSkins.has(CUSTOM_SKIN_ID)) {
                html += `<h3 style="color: #0f0;">ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—</h3>`;
                html += createSkinListEntry(CUSTOM_SKIN_ID, null);
            }

            // Default Skin
            html += `<h3>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</h3>`;
            html += createSkinListEntry(defaultSkin, null);
            
            // Rare Skins
            html += `<h3 style="color: #ffaa00;">é©å‘½çš„åŒå¿— (ãƒ¬ã‚¢)</h3>`;
            RARE_SKINS.forEach(rareInfo => {
                html += createSkinListEntry(rareInfo.name, rareInfo);
            });

            // Normal Skins
            html += `<h3 style="color: #ccc;">ä¸€èˆ¬åŒå¿—</h3>`;
            normalSkinNames.forEach(skinName => {
                html += createSkinListEntry(skinName, null);
            });

            container.innerHTML = html;
        }

        function createSkinListEntry(skinName, rareInfo) {
            const isOwned = ownedSkins.has(skinName);

            let nameDisplay = skinName.replace('.png', '').replace('.jpg', '');
            if (skinName === CUSTOM_SKIN_ID) {
                nameDisplay = 'ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—';
            }

            let probabilityText = "";

            if (rareInfo) {
                let percent = (rareInfo.rate * 100).toFixed(3).replace(/\.?0+$/, ""); // å°æ•°ç‚¹ä»¥ä¸‹ã‚’æ•´å½¢
                
                // â˜…ä¿®æ­£â˜…: å¸¸ã«ã€Œãƒ¬ã‚¢ã‚¬ãƒãƒ£ã€ã¨è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«æ¡ä»¶åˆ†å²ã‚’å‰Šé™¤
                probabilityText = ` (${rareInfo.rarity}, ãƒ¬ã‚¢ã‚¬ãƒãƒ£ ${percent}%)`;
            
            } else if (skinName === CUSTOM_SKIN_ID) {
                probabilityText = isCustomSkinAnimated ? " (ã‚«ã‚¹ã‚¿ãƒ , GIF)" : " (ã‚«ã‚¹ã‚¿ãƒ )";
            } else if (skinName !== 'player.png') {
                probabilityText = " (ãƒãƒ¼ãƒãƒ«ã‚¬ãƒãƒ£)";
            } else {
                probabilityText = " (åˆæœŸ)";
            }
            
            const ownedClass = isOwned ? 'owned' : 'not-owned';
            const ownedText = isOwned ? '[æ‰€æŒ]' : '[æœªæ‰€æŒ]';
            
            let entry = `<div>
                            <span class="${ownedClass}">${ownedText} ${nameDisplay}</span>
                            <span class="skin-prob">${probabilityText}</span>
                         </div>`;
            return entry;
        }

        // ==========================================
        // â˜…â˜…â˜… ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³æ©Ÿèƒ½ â˜…â˜…â˜… (GIFå¯¾å¿œ)
        // ==========================================

        function setupCustomSkinUploader() {
            const uploader = document.getElementById('custom-skin-upload');
            const preview = document.getElementById('custom-skin-preview');
            const saveButton = document.getElementById('custom-skin-save');

            uploader.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    saveButton.dataset.fileType = file.type; 

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        saveButton.disabled = false;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.src = '';
                    preview.style.display = 'none';
                    saveButton.disabled = true;
                    saveButton.dataset.fileType = ''; 
                }
            });
        }

        function openCustomSkinScreen() {
            document.getElementById('custom-skin-screen').classList.remove('hidden');
            // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('custom-skin-upload').value = null;
            document.getElementById('custom-skin-preview').style.display = 'none';
            document.getElementById('custom-skin-save').disabled = true;
            document.getElementById('custom-skin-save').dataset.fileType = '';
        }

        function closeCustomSkinScreen() {
            document.getElementById('custom-skin-screen').classList.add('hidden');
        }

        function saveCustomSkin() {
            const preview = document.getElementById('custom-skin-preview');
            const saveButton = document.getElementById('custom-skin-save');
            const dataURL = preview.src;
            const fileType = saveButton.dataset.fileType; 

            if (dataURL) {
                try {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã‚’å°‚ç”¨ã‚­ãƒ¼ã§localStorageã«ä¿å­˜
                    localStorage.setItem(CUSTOM_SKIN_KEY, dataURL);
                    customSkinDataURL = dataURL; 
                    
                    if (fileType === 'image/gif') {
                        localStorage.setItem(CUSTOM_SKIN_TYPE_KEY, 'gif');
                        isCustomSkinAnimated = true;
                        customSkinGifElement.src = dataURL; // <img>è¦ç´ ã«ã™ãåæ˜ 
                    } else {
                        localStorage.setItem(CUSTOM_SKIN_TYPE_KEY, 'static');
                        isCustomSkinAnimated = false;
                    }
                    
                    if (!ownedSkins.has(CUSTOM_SKIN_ID)) {
                        ownedSkins.add(CUSTOM_SKIN_ID);
                    }
                    
                    // æ–°ã—ã„ã‚¹ã‚­ãƒ³ã‚’å³åº§ã«é©ç”¨ã—ã€(currentSkinã¨ã—ã¦)ä¿å­˜ã™ã‚‹
                    changeSkin(CUSTOM_SKIN_ID); // ã“ã‚ŒãŒ applySkin ã¨ saveData ã‚’å‘¼ã¶
                    updateSkinSelectorUI(); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°

                    alert("ã‚ªãƒªã‚¸ãƒŠãƒ«åŒå¿—ã‚’ä½œæˆã—ã¾ã—ãŸï¼");
                    closeCustomSkinScreen();

                } catch (e) {
                    console.error("ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®ä¿å­˜ã«å¤±æ•—", e);
                    alert("ã‚¹ã‚­ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                }
            }
        }

        // ==========================================
        // ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã (ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰)
        // ==========================================

        function saveData() {
            try {
                const data = {
                    skins: Array.from(ownedSkins),
                    balls: mutekiBalls,
                    skin: currentSkin,
                    highScore: highScore, 
                    highDistance: highDistance,
                    isAwakeningUnlocked: isAwakeningUnlocked 
                };
                // â˜…æ³¨æ„: ã“ã“ã«ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®ç”»åƒãƒ‡ãƒ¼ã‚¿(dataURL)ã¯å«ã¾ã‚Œãªã„
                localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(data));
                console.log("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", data);
            } catch (e) {
                console.error("ã‚»ãƒ¼ãƒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
            }
        }

        function loadData() {
            // 1. ãƒ¡ã‚¤ãƒ³ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            try {
                const jsonData = localStorage.getItem(SAVE_DATA_KEY);
                if (jsonData) {
                    const data = JSON.parse(jsonData);
                    
                    ownedSkins = new Set(data.skins || ['player.png']); 
                    mutekiBalls = data.balls || 0;
                    currentSkin = data.skin || 'player.png';
                    highScore = data.highScore || 0; 
                    highDistance = data.highDistance || 0; 
                    isAwakeningUnlocked = data.isAwakeningUnlocked || false; 
                    
                    console.log("ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚", data);
                    
                    updateMutekiCountUI();
                }
            } catch (e) {
                console.error("ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
            }

            // 2. ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            try {
                const customData = localStorage.getItem(CUSTOM_SKIN_KEY);
                const customType = localStorage.getItem(CUSTOM_SKIN_TYPE_KEY); 

                if (customData) {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãƒ‡ãƒ¼ã‚¿(DataURL)ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
                    customSkinDataURL = customData;
                    ownedSkins.add(CUSTOM_SKIN_ID); // æ‰€æœ‰ãƒªã‚¹ãƒˆã«å¼·åˆ¶è¿½åŠ 
                    
                    if (customType === 'gif') {
                        isCustomSkinAnimated = true;
                        customSkinGifElement.src = customSkinDataURL; // <img>ã«ã‚»ãƒƒãƒˆ
                    } else {
                        isCustomSkinAnimated = false;
                    }

                } else {
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãªã©)
                    customSkinDataURL = null;
                    isCustomSkinAnimated = false; // ãƒªã‚»ãƒƒãƒˆ
                    ownedSkins.delete(CUSTOM_SKIN_ID); // æ‰€æœ‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    if (currentSkin === CUSTOM_SKIN_ID) {
                        currentSkin = 'player.png'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                    }
                }
            } catch (e) {
                console.error("ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—", e);
                isCustomSkinAnimated = false;
            }

            // 3. æœ€çµ‚çš„ãªã‚¹ã‚­ãƒ³ã‚’é©ç”¨
            if (player) { 
                applySkin(currentSkin);
            }
            
            // 4. UIã‚’æ›´æ–°
            updateSkinSelectorUI();
            updateHighScoreUI(); 
            updateAwakeningUI(); 
        }

        // --- å¼•ãç¶™ãç”»é¢UI ---
        function openSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.remove('hidden');
            document.getElementById('save-load-code').value = ''; 
        }
        
        function closeSaveLoadScreen() {
            document.getElementById('save-load-screen').classList.add('hidden');
        }

        function generateSaveCode() {
            saveData(); // â˜…æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ (ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ã®DataURLã¯å«ã¾ãªã„)
            const jsonData = localStorage.getItem(SAVE_DATA_KEY);
            if (jsonData) {
                try {
                    const base64Code = btoa(jsonData);
                    document.getElementById('save-load-code').value = base64Code;
                    alert("å¼•ãç¶™ãã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
                } catch (e) {
                    alert("ã‚³ãƒ¼ãƒ‰ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            }
        }

        function executeLoadCode() {
            const base64Code = document.getElementById('save-load-code').value;
            if (!base64Code) {
                alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            try {
                const jsonData = atob(base64Code);
                const data = JSON.parse(jsonData); 
                
                if (data && typeof data.skins !== 'undefined' && typeof data.balls !== 'undefined') {
                    // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä¿å­˜
                    localStorage.setItem(SAVE_DATA_KEY, jsonData);
                    
                    // â˜…é‡è¦: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ³ãƒ‡ãƒ¼ã‚¿(KEY/TYPE_KEY)ã¯ä¸Šæ›¸ãã—ãªã„
                    
                    alert("ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
                    location.reload(); 
                } else {
                    throw new Error("ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚");
                }
            } catch (e) {
                console.error("ãƒ­ãƒ¼ãƒ‰å¤±æ•—:", e);
                alert("ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        // ==========================================
        // è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆç”¨
        // ==========================================

        function updateAwakeningUI() {
            const unlockBtn = document.getElementById('awakening-unlock-btn');
            const startBtn = document.getElementById('awakening-start-btn');
            const unlockBtnOver = document.getElementById('awakening-unlock-btn-over');
            const startBtnOver = document.getElementById('awakening-start-btn-over');

            if (isAwakeningUnlocked) {
                // è§£æ”¾æ¸ˆã¿
                unlockBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                unlockBtnOver.classList.add('hidden');
                startBtnOver.classList.remove('hidden');
            } else {
                // æœªè§£æ”¾
                unlockBtn.classList.remove('hidden');
                startBtn.classList.add('hidden');
                unlockBtnOver.classList.remove('hidden');
                startBtnOver.classList.add('hidden');

                // ã‚³ã‚¹ãƒˆãŒè¶³ã‚Šã¦ã„ã‚‹ã‹
                if (mutekiBalls >= AWAKENING_UNLOCK_COST) {
                    unlockBtn.disabled = false;
                    unlockBtnOver.disabled = false;
                    unlockBtn.innerText = `è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆè§£æ”¾ (ç„¡æ•µ ${AWAKENING_UNLOCK_COST}å€‹æ¶ˆè²»)`;
                    unlockBtnOver.innerText = `è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆè§£æ”¾ (ç„¡æ•µ ${AWAKENING_UNLOCK_COST}å€‹æ¶ˆè²»)`;
                } else {
                    unlockBtn.disabled = true;
                    unlockBtnOver.disabled = true;
                    unlockBtn.innerText = `è§£æ”¾ (ç„¡æ•µ ${AWAKENING_UNLOCK_COST}å€‹å¿…è¦)`;
                    unlockBtnOver.innerText = `è§£æ”¾ (ç„¡æ•µ ${AWAKENING_UNLOCK_COST}å€‹å¿…è¦)`;
                }
            }
        }

        function unlockAwakening() {
            if (isAwakeningUnlocked) return; 
            
            if (mutekiBalls >= AWAKENING_UNLOCK_COST) {
                mutekiBalls -= AWAKENING_UNLOCK_COST;
                isAwakeningUnlocked = true;
                
                updateMutekiCountUI();
                updateAwakeningUI();
                saveData(); // ä¿å­˜
                
                alert(`è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆã‚’è§£æ”¾ã—ã¾ã—ãŸï¼\n(ç„¡æ•µãƒœãƒ¼ãƒ« ${AWAKENING_UNLOCK_COST}å€‹æ¶ˆè²»)`);
            } else {
                alert(`ç„¡æ•µãƒœãƒ¼ãƒ«ãŒ ${AWAKENING_UNLOCK_COST}å€‹ å¿…è¦ã§ã™ã€‚`);
            }
        }

        function startAwakeningGame() {
            if (!isAwakeningUnlocked) {
                alert("è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆã¯è§£æ”¾ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }

            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‹ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‹ã‚’åˆ¤å®šã—ã¦é–‰ã˜ã‚‹
            if (!document.getElementById('start-screen').classList.contains('hidden')) {
                startGame(true); // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‹ã‚‰è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆ
            } else if (!document.getElementById('game-over-screen').classList.contains('hidden')) {
                resetGame(true); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‹ã‚‰è¦šé†’ã‚¹ã‚¿ãƒ¼ãƒˆ
            }
        }
        // â–²â–²â–² è¿½åŠ  â–²â–²â–²

        // ã‚¹ã‚¿ãƒ¼ãƒˆ
        init();

    </script>
</body>
</html>
